---
title: "Skin Optics Analysis based on ISSA Data"
author: "Junhui He and Tina Lasisi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Load required libraries
library(knitr)
library(tidyverse)
library(scales)
library(dplyr)
library(openxlsx)
library(KernSmooth)
library(here)
library(ggpubr)

# Set global chunk options for the document
knitr::opts_chunk$set(
  echo = FALSE,        # Don't show code in output
  include = TRUE,      # Include output
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Don't show warnings
  message = FALSE,     # Don't show messages
  fig.retina = 2,      # Higher resolution figures
  fig.width = 8,       # Default figure width
  fig.height = 6,      # Default figure height
  out.width = "100%",  # Full width in HTML output
  autodep = TRUE       # Automatic dependency tracking for cached chunks
)

# Define output directory
OUTPUT_DIR <- here::here("output")

# Helper function to save plots to PDF
save_pdf <- function(plot_obj, filename, width = 10, height = 5, dir = OUTPUT_DIR) {
  filepath <- file.path(dir, filename)
  ggsave(filename = filepath, plot = plot_obj, width = width, height = height, device = "pdf")
  invisible(filepath)
}
```

# Clarifications

- Melanin index (MI) is calculated from skin reflectance at 680 nm, where $R_{680}$ is the measured reflectance percentage (0-100):
  - $$MI = -100 \times \log_{10}(R_{680} / 100)$$
  - This is equivalent to the standard formula $MI = 100 \times \log_{10}(1/R)$, where $R$ is reflectance as a decimal (0-1)
  - Internally, this is computed by first calculating absorbance ($A_{680} = -\log_{10}(R_{680} / 100)$), then multiplying by 100

- Erythema index (EI) is calculated as: $$EI = 100 \times \log_{10}\left(\frac{R_{680}}{(R_{550} + R_{560})/2}\right)$$ where $R_{550}$, $R_{560}$, and $R_{680}$ are the reflectance percentages at 550 nm, 560 nm, and 680 nm, respectively.

- EI variability is measured by the standard deviation of EIs within a sliding window of MI values. The window size is set to 20 MI units, and the step size is 1 MI unit.
  - For each center MI value in the sequence, all EI values corresponding to MI values within the window (center MI $\pm$ 10) are collected, and their standard deviation is computed.
  - The center MI values range from the 1st to the 99th percentile of observed MI values.

- FACE site refers to Forehead or Cheek, while PALM site refers to the Palm of the hand. 

- Representative FACE MI: 
  - For each subject, the FACE MI is given by the Forehead MI if the Forehead MI is available; otherwise, it is the Cheek MI.
  - For subjects with multiple measurements at the same FACE site, we randomly select one measurement.
  - Each subject has only one representative FACE reflectance spectra.

- First derivatives of skin spectra are estimated using local polynomial regression with bandwidth selected by the dpill function, scaled by a factor of 0.7.

- Eumelanin classes are defined based on melanin index ranges as follows:
  - Low: $MI < 25$
  - Intermediate low: $25 \leq MI < 50$
  - Intermediate: $50 \leq MI < 75$
  - Intermediate high: $75 \leq MI < 100$
  - High: $MI \geq 100$

- The pdf files generated in this analysis are saved in the "output" directory.

# Visualizations

```{r load_issa}
# Load the ISSA skin spectrum reflectance data
issa_path <- here::here("data", "ISSA_17_Jan_2025_Yan_Lu.xlsx")
issa_code <- read.xlsx(issa_path, sheet = 1)
issa_data <- read.xlsx(issa_path, sheet = 2)

# Extract the skin spectrum data
issa <- issa_data[10:nrow(issa_data), ] # 360 nm: 13rd column, 780 nm: 55th column
colnames(issa) <- issa_data[9, ]

# Define body site codes and names
body_codes = as.character(1:12)
body_names = c("Back of Hand", "Cheek", "Cheek bone", "Chin", "Ear Lobe", "Forehead", "Inner arm", "Neck", "Nose tip", "Outer arm", "Palm", "Ring finger")
issa$G = body_names[as.numeric(issa$G)]
```

```{r compute}
# compute melanin index and erythema index
reflectance_to_absorbance <- function(reflectance) {
  -log10(reflectance / 100)
}

wavelengths = seq(400, 700, by=10)
reflectance = issa %>% dplyr::select(`400`:`700`)
colnames(reflectance) = paste0("R", wavelengths)
# calculate absorbance
absorbance = as.data.frame(lapply(reflectance, reflectance_to_absorbance))
colnames(absorbance) = paste0("A", wavelengths)
spectrum = cbind(issa %>% dplyr::select(A, C, G), reflectance, absorbance)
# calculate melanin index and erythema index
spectrum = spectrum %>% mutate(mi = 100 * `A680`,
                               ei = 100 * log10(`R680` / ((`R550` + `R560`)/2)))
colnames(spectrum)[3] = "site" # rename G to site
# extract face and palm spectra
face_ids = unique(issa$C[issa$G %in% c("Forehead", "Cheek")])

# Check face data before deduplication
face_temp = spectrum %>% filter(site %in% c("Forehead", "Cheek"))
cat("Face readings before deduplication:", nrow(face_temp), "\n")
cat("Unique individuals with Face readings:", n_distinct(face_temp$C), "\n")

# Deduplicate face data: prioritize Forehead over Cheek, one reading per person
face_spectrum = face_temp %>%
  arrange(C, site) %>%  # "Cheek" comes before "Forehead" alphabetically, so reverse
  mutate(site_priority = if_else(site == "Forehead", 1, 2)) %>%
  arrange(C, site_priority) %>%
  group_by(C) %>%
  slice(1) %>%
  ungroup() %>%
  select(-site_priority) %>%
  mutate(site = "Forehead/Cheek")

cat("Face readings after deduplication:", nrow(face_spectrum), "\n")

# Check for duplicates and deduplicate palm data (same as face)
palm_temp = spectrum %>% filter(C %in% face_ids, site == "Palm")
cat("Palm readings before deduplication:", nrow(palm_temp), "\n")
cat("Unique individuals with Palm readings:", n_distinct(palm_temp$C), "\n")

# Deduplicate: one Palm reading per person
palm_spectrum = palm_temp %>%
  group_by(C) %>%
  slice_sample(n = 1) %>%
  ungroup()

cat("Palm readings after deduplication:", nrow(palm_spectrum), "\n")
```


```{r util_plot_functions}
# ==============================================================================
# PLOTTING FUNCTIONS
# ==============================================================================

#' Generate skin reflectance spectra plot
#' 
#' Creates a plot showing reflectance spectra colored by melanin index
#' 
#' @param data 
#' @return A ggplot object
PlotReflectance <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>% 
    # Convert to long format
    pivot_longer(cols = matches("^R[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "reflectance") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
  
  plot <- ggplot(data_long, aes(x = wavelength, y = reflectance, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#fbf7ec"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    labs(
      x = "Wavelength (nm)",
      y = "Reflectance percentage of skin",
      color = "Melanin index"
    ) +
    guides(color = guide_colorbar(reverse = TRUE)) # +
    # Highlight the region used for melanin index calculation
    # geom_vline(xintercept = 680, color = "#ff0000")
  
  return(plot)
}

#' Generate skin absorbance spectra plot
#' 
#' Creates a plot showing absorbance spectra colored by melanin index
#' 
#' @param data 
#' @return A ggplot object
PlotAbsorbance <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>% 
    # Convert to long format
    pivot_longer(cols = matches("^A[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "absorbance") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
  
  plot <- ggplot(data_long, aes(x = wavelength, y = absorbance, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#fbf7ec"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    labs(
      x = "Wavelength (nm)",
      y = "Absorbance of skin",
      color = "Melanin index"
    ) +
    guides(color = guide_colorbar(reverse = TRUE)) +
    # Highlight the region used for melanin index calculation
    geom_vline(xintercept = 680, color = "#ff0000")
  
  return(plot)
}
```

```{r plot-derivatives}
# plot the first derivatives
PlotDerivative <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>%
    # Convert to long format
    pivot_longer(cols = matches("^[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "delta") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
    
  plot <- ggplot(data_long, aes(x = wavelength, y = delta, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    geom_hline(yintercept = 0, color = "black") +
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#fbf7ec"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    guides(color = guide_colorbar(reverse = TRUE))
  
  return(plot)
}
```

```{r derivatives-face, cache=TRUE}

face_reflectance = as.matrix(face_spectrum %>% dplyr::select(`R400`:`R700`))
face_absorbance = as.matrix(face_spectrum %>% dplyr::select(`A400`:`A700`))

drv_facer = t(apply(face_reflectance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_facer) = wavelengths
drv_facer_df = as.data.frame(drv_facer) %>% mutate(A = face_spectrum$A, mi = face_spectrum$mi)

drv_facea = t(apply(face_absorbance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_facea) = wavelengths
drv_facea_df = as.data.frame(drv_facea) %>% mutate(A = face_spectrum$A, mi = face_spectrum$mi)
```

```{r outliers}
# remove outliers
outlier_index = which(drv_facer_df$`700`>1)
face_spectrum = face_spectrum[-outlier_index, ]
drv_facer = drv_facer[-outlier_index, ]
drv_facea = drv_facea[-outlier_index, ]
drv_facer_df = drv_facer_df[-outlier_index, ]
drv_facea_df = drv_facea_df[-outlier_index, ]


plot_drv_facer = PlotDerivative(drv_facer_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin reflectance",
      title = "First derivatives of skin reflectance",
      color = "Melanin index"
    )

plot_drv_facea = PlotDerivative(drv_facea_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin absorbance",
      title = "First derivatives of skin absorbance",
      color = "Melanin index"
    )
```

```{r derivatives-palm, fig.height=5, cache=TRUE}
palm_reflectance = as.matrix(palm_spectrum %>% dplyr::select(`R400`:`R700`))
palm_absorbance = as.matrix(palm_spectrum %>% dplyr::select(`A400`:`A700`))

drv_palmr = t(apply(palm_reflectance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_palmr) = wavelengths
drv_palmr_df = as.data.frame(drv_palmr) %>% mutate(A = palm_spectrum$A, C = palm_spectrum$C, mi = palm_spectrum$mi)
plot_drv_palmr = PlotDerivative(drv_palmr_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin reflectance",
      title = "First derivatives of skin reflectance",
      color = "Melanin index"
    )

drv_palma = t(apply(palm_absorbance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials
colnames(drv_palma) = wavelengths
drv_palma_df = as.data.frame(drv_palma) %>% mutate(A = palm_spectrum$A, C = palm_spectrum$C, mi = palm_spectrum$mi)
plot_drv_palma = PlotDerivative(drv_palma_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin absorbance",
      title = "First derivatives of skin absorbance",
      color = "Melanin index"
    )
```

```{r face mi}
# calculate representative face melanin index for each subject
face_ids = unique(issa$C[issa$G %in% c("Forehead", "Cheek")])
spectrum_filtered = spectrum %>% filter(C %in% face_ids)
spectrum_filtered$face_mi = NaN
for (id in face_ids) {
  spectrum_id = spectrum_filtered %>% filter(C == id)
  if (any(spectrum_id$site == "Forehead")) {
    face_mi = mean(spectrum_id$mi[spectrum_id$site == "Forehead"], na.rm = TRUE)
  } else {
    face_mi = mean(spectrum_id$mi[spectrum_id$site == "Cheek"], na.rm = TRUE)
  }
  spectrum_filtered$face_mi[spectrum_filtered$C == id] = face_mi
}

# define eumelanin classes based on representative face melanin index
eumelanin_classes_person = cut(spectrum_filtered$face_mi, breaks=c(0, 25, 50, 75, 100, 200))
eumelanin_classes_person = factor(eumelanin_classes_person, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high", "High"))

site_info = data.frame(subject = spectrum_filtered$C,
                       site = spectrum_filtered$site,
                       eumelanin_class = eumelanin_classes_person,
                       face_mi = spectrum_filtered$face_mi)
```

## Distribution of melanin index by site


```{r sample distribution, fig.width=4, fig.height=7, out.width="50%"}
# distribution of melanin index for Forehead, Cheek, and Palm
facepalm_spectrum = rbind(face_spectrum, palm_spectrum)

# Verify no duplicates per site
cat("\nFinal data summary:\n")
cat("Face: n =", nrow(face_spectrum), "| Unique individuals:", n_distinct(face_spectrum$C), "\n")
cat("Palm: n =", nrow(palm_spectrum), "| Unique individuals:", n_distinct(palm_spectrum$C), "\n")
cat("Combined: n =", nrow(facepalm_spectrum), "\n")

# Calculate n for each site
mi_site_n <- facepalm_spectrum %>%
  group_by(site) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
mi_site_labels <- setNames(mi_site_n$label, mi_site_n$site)

p <- ggplot(facepalm_spectrum, aes(x = mi, fill = site)) +
  geom_histogram(alpha = 0.7, position = "identity", binwidth = 5) +
  labs(x = "Melanin index", y = "Count", fill = "Site", 
       title = "Distribution of Melanin Index by Site") +
  xlim(0, 120) +
  scale_fill_brewer(palette = "Set2") +
  facet_wrap(~site, ncol = 1, labeller = as_labeller(mi_site_labels)) +
  theme_classic() +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "mi_distribution.pdf", width = 4, height = 7)
```

## Unique subjects per site across representative face melanin index bins (Heatmap)


```{r heatmap, fig.width=12, fig.height=6}
# 1) Cut mi into 10 equal-width bins (adjust breaks as needed)
df_bins <- site_info %>%
  mutate(mi_bin = cut(face_mi, breaks = seq(0, 130, by = 10))) %>%
  count(site, mi_bin, name = "n")

df_bins <- df_bins %>%
  tidyr::complete(site, mi_bin, fill = list(n = 0))

# 3) Calculate row totals
row_totals <- df_bins %>%
  group_by(site) %>%
  summarise(total = sum(n))

# 4) Add row totals as new column with label
df_bins_with_totals <- df_bins %>%
  left_join(row_totals, by = "site") %>%
  mutate(site_label = paste0(site, " (n=", total, ")"))

# 2) Heatmap with site labels showing totals
p <- ggplot(df_bins_with_totals, aes(x = mi_bin, y = site_label, fill = n)) +
  geom_tile(color = "white") +
  geom_text(aes(label = n), color = "white", size = 3) +
  scale_fill_viridis_c(option = "viridis") +
  labs(x = "Face MI, binned in 10-unit increments", y = "Site", fill = "Subject",
       title = "Unique subjects per site across 10-unit Face MI bins") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

print(p)
save_pdf(p, "heatmap.pdf", width = 12, height = 6)
```

```{r eumelanin-class}
eumelanin_classes_face = cut(face_spectrum$mi, breaks=c(0, 25, 50, 75, 100, 150))
eumelanin_classes_face = factor(eumelanin_classes_face, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high", "High"))
face_spectrum$class = eumelanin_classes_face
drv_facer_df$class = eumelanin_classes_face
drv_facea_df$class = eumelanin_classes_face

eumelanin_classes_palm = cut(palm_spectrum$mi, breaks=c(0, 25, 50, 75, 100)) # no "High" class for palm
eumelanin_classes_palm = factor(eumelanin_classes_palm, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high"))
palm_spectrum$palm_class = eumelanin_classes_palm
drv_palmr_df$palm_class = eumelanin_classes_palm
drv_palma_df$palm_class = eumelanin_classes_palm

palm_spectrum$face_class = eumelanin_classes_face[match(palm_spectrum$C, face_spectrum$C)]
drv_palmr_df$face_class = palm_spectrum$face_class
drv_palma_df$face_class = palm_spectrum$face_class

# report the table of the number of subjects in each class
kable(table(eumelanin_classes_face), col.names = c("Eumelanin class", "Number of subjects"), caption = "Number of subjects in each eumelanin class (Forehead/Cheek)")
kable(table(eumelanin_classes_palm), col.names = c("Eumelanin class", "Number of subjects"), caption = "Number of subjects in each eumelanin class (Palm)")
```

## Reflectance by eumelanin classes

### Face reflectance by face eumelanin class

```{r plot-raw-reflectance-by-class-face, fig.width=12, fig.height=4}
# Calculate n for each class
face_class_n <- face_spectrum %>%
  group_by(class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(class, "\n(n=", n, ")"))
face_class_labels <- setNames(face_class_n$label, face_class_n$class)

p_raw_face <- PlotReflectance(face_spectrum) + 
  facet_wrap(~class, nrow = 1, labeller = as_labeller(face_class_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Reflectance",
    title = "Face reflectance by Face eumelanin classes",
    color = "Face melanin index"
  ) + 
  ylim(0, 75) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank())

print(p_raw_face)
save_pdf(p_raw_face, "reflectance_face.pdf", width = 12, height = 4)
```

### Palm reflectance by palm eumelanin class

```{r plot-raw-reflectance-by-class-palm, fig.width=12, fig.height=4}
# Calculate n for each palm class
palm_class_n <- palm_spectrum %>%
  group_by(palm_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(palm_class, "\n(n=", n, ")"))
palm_class_labels <- setNames(palm_class_n$label, palm_class_n$palm_class)

p <- PlotReflectance(palm_spectrum) + 
  facet_wrap(~palm_class, nrow = 1, labeller = as_labeller(palm_class_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Reflectance",
    title = "Palm reflectance by Palm eumelanin classes",
    color = "Palm melanin index"
  ) + 
  ylim(0, 75) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "reflectance_palm.pdf", width = 12, height = 4)
```

### Palm reflectance by face eumelanin class
```{r plot-raw-reflectance-by-class-palm-face, fig.width=12, fig.height=4}
# Calculate n for each face class (for palm spectra)
palm_faceclass_n <- palm_spectrum %>%
  group_by(face_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(face_class, "\n(n=", n, ")"))
palm_faceclass_labels <- setNames(palm_faceclass_n$label, palm_faceclass_n$face_class)

p_raw_palm_face <- PlotReflectance(palm_spectrum) + 
  facet_wrap(~face_class, nrow = 1, labeller = as_labeller(palm_faceclass_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Reflectance",
    title = "Palm reflectance by Face eumelanin classes",
    color = "Face melanin index"
  ) + 
  ylim(0, 75) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank())

print(p_raw_palm_face)
save_pdf(p_raw_palm_face, "reflectance_palm_face.pdf", width = 12, height = 4)
```

## First derivatives of reflectance by eumelanin classes

### Face reflectance derivatives by face eumelanin class

```{r plot-reflectance-by-class-face, fig.width=12, fig.height=4}
# Calculate n for each class (derivatives)
face_deriv_n <- drv_facer_df %>%
  group_by(class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(class, "\n(n=", n, ")"))
face_deriv_labels <- setNames(face_deriv_n$label, face_deriv_n$class)

p_deriv_face <- PlotDerivative(drv_facer_df) + 
  facet_wrap(~class, nrow = 1, labeller = as_labeller(face_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of Face reflectance by Face eumelanin classes",
    color = "Face melanin index"
  ) + 
  ylim(-0.6, 0.8) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank())

print(p_deriv_face)
save_pdf(p_deriv_face, "reflectance_derivative_face.pdf", width = 12, height = 4)
```

### Palm reflectance derivatives by palm eumelanin class

```{r plot-reflectance-by-class-palm, fig.width=12, fig.height=4}
# Calculate n for each palm class (derivatives)
palm_deriv_n <- drv_palmr_df %>%
  group_by(palm_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(palm_class, "\n(n=", n, ")"))
palm_deriv_labels <- setNames(palm_deriv_n$label, palm_deriv_n$palm_class)

p <- PlotDerivative(drv_palmr_df) + 
  facet_wrap(~palm_class, nrow = 1, labeller = as_labeller(palm_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of Palm reflectance by Palm eumelanin classes",
    color = "Palm melanin index"
  ) + 
  ylim(-0.6, 0.8) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "reflectance_derivative_palm.pdf", width = 12, height = 4)
```

### Palm reflectance derivatives by face eumelanin class

```{r plot-reflectance-by-class-palm-face, fig.width=12, fig.height=4}
# Calculate n for each face class (palm derivatives)
palm_deriv_faceclass_n <- drv_palmr_df %>%
  group_by(face_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(face_class, "\n(n=", n, ")"))
palm_deriv_faceclass_labels <- setNames(palm_deriv_faceclass_n$label, palm_deriv_faceclass_n$face_class)

p_deriv_palm_face <- PlotDerivative(drv_palmr_df) + 
  facet_wrap(~face_class, nrow = 1, labeller = as_labeller(palm_deriv_faceclass_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of Palm reflectance by Face eumelanin classes",
    color = "Face melanin index"
  ) + 
  ylim(-0.6, 0.8) +
  theme(legend.position = "bottom")

print(p_deriv_palm_face)
save_pdf(p_deriv_palm_face, "reflectance_derivative_palm_face.pdf", width = 12, height = 4)
```

## Composite figure: Face reflectance and derivatives by eumelanin class

```{r composite-reflectance-derivatives, fig.width=12, fig.height=16}
# Combine the four plots into a composite figure
composite_plot <- ggarrange(
  p_raw_face, p_raw_palm_face, p_deriv_face, p_deriv_palm_face,
  labels = c("a", "b", "c", "d"),
  ncol = 1, nrow = 4,
  common.legend = TRUE,
  legend = "bottom"
)

print(composite_plot)
save_pdf(composite_plot, "composite_reflectance_derivatives.pdf", width = 12, height = 16)
```

## First derivatives of absorbance by eumelanin classes

### Face absorbance derivatives by face eumelanin class

```{r plot-absorbance-by-class-face, fig.width=12, fig.height=4}
# Calculate n for each class (absorbance derivatives)
face_abs_deriv_n <- drv_facea_df %>%
  group_by(class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(class, "\n(n=", n, ")"))
face_abs_deriv_labels <- setNames(face_abs_deriv_n$label, face_abs_deriv_n$class)

p <- PlotDerivative(drv_facea_df) + 
  facet_wrap(~class, nrow = 1, labeller = as_labeller(face_abs_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of Face absorbance by Face eumelanin classes",
    color = "Face melanin index"
  ) + 
  ylim(-0.02, 0.02) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "absorbance_derivative_face.pdf", width = 12, height = 4)
```

### Palm absorbance derivatives by palm eumelanin class

```{r plot-absorbance-by-class-palm, fig.width=12, fig.height=4}
# Calculate n for each palm class (absorbance derivatives)
palm_abs_deriv_n <- drv_palma_df %>%
  group_by(palm_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(palm_class, "\n(n=", n, ")"))
palm_abs_deriv_labels <- setNames(palm_abs_deriv_n$label, palm_abs_deriv_n$palm_class)

p <- PlotDerivative(drv_palma_df) + 
  facet_wrap(~palm_class, nrow = 1, labeller = as_labeller(palm_abs_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of Palm absorbance by Palm eumelanin classes",
    color = "Palm melanin index"
  ) + 
  ylim(-0.02, 0.02) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "absorbance_derivative_palm.pdf", width = 12, height = 4)
```

### Palm absorbance derivatives by face eumelanin class

```{r plot-absorbance-by-class-palm-face, fig.width=12, fig.height=4}
# Calculate n for each face class (palm absorbance derivatives)
palm_abs_deriv_faceclass_n <- drv_palma_df %>%
  group_by(face_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(face_class, "\n(n=", n, ")"))
palm_abs_deriv_faceclass_labels <- setNames(palm_abs_deriv_faceclass_n$label, palm_abs_deriv_faceclass_n$face_class)

p <- PlotDerivative(drv_palma_df) + 
  facet_wrap(~face_class, nrow = 1, labeller = as_labeller(palm_abs_deriv_faceclass_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of Palm absorbance by Face eumelanin classes",
    color = "Palm melanin index"
  ) + 
  ylim(-0.02, 0.02) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "absorbance_derivative_palm_face.pdf", width = 12, height = 4)
```

```{r derivative-sd-mi}
# calculate the standard deviations in derivatives for a spectra curve
# face
sd_ref_face = apply(drv_facer, MARGIN = 1, sd)
sd_abs_face = apply(drv_facea, MARGIN = 1, sd)
sd_face = data.frame(site = "Forehead/Cheek", sd_ref = sd_ref_face, sd_abs = sd_abs_face, mi = face_spectrum$mi) %>% mutate(log_mi = log(mi))
# palm
sd_ref_palm = apply(drv_palmr, MARGIN = 1, sd)
sd_abs_palm = apply(drv_palma, MARGIN = 1, sd)
sd_palm = data.frame(site = "Palm", sd_ref = sd_ref_palm, sd_abs = sd_abs_palm, mi = palm_spectrum$mi) %>% mutate(log_mi = log(mi))
```

## Correlation between reflectance derivative sd and melanin index

```{r plot-derivative-sd-mi-ref, fig.width=10, fig.height=5}
# Combine face and palm data for faceted plotting
sd_combined = bind_rows(sd_face, sd_palm)

# Calculate n for each site
sd_site_n <- sd_combined %>%
  group_by(site) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
sd_site_labels <- setNames(sd_site_n$label, sd_site_n$site)

p <- ggplot(data = sd_combined, aes(x = log_mi, y = sd_ref, color = site)) + 
  geom_point(size = 0.8, alpha = 0.7) + 
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(sd_site_labels)) +
  theme_classic() +
  labs(title = "Correlation between reflectance derivative sd and melanin index",
       x = "log(Melanin index)",
       y = "Standard deviation of derivatives") + 
  ylim(0, 0.25) + xlim(2.75, 4.75) +
  theme(legend.position = "none")

print(p)
save_pdf(p, "reflectance_mi_sd.pdf", width = 10, height = 5)
```

- Regression analysis

```{r regression-drv-mi, fig.width=10, fig.height=5}
# polynomial regression for reflectance sd vs log(mi)
# face
reg_face_model = lm(sd_ref ~ log_mi + I(log_mi^2), data = sd_face)
summary(reg_face_model)

# palm
reg_palm_model = lm(sd_ref ~ log_mi, data = sd_palm)
summary(reg_palm_model)

# Plot with regression lines using facets
p <- ggplot(data = sd_combined, aes(x = log_mi, y = sd_ref, color = site)) + 
  geom_point(size = 0.8, alpha = 0.7) + 
  geom_smooth(data = filter(sd_combined, site == "Forehead/Cheek"), 
              method = "lm", formula = y ~ poly(x, 2), color = "black", se = FALSE) +
  geom_smooth(data = filter(sd_combined, site == "Palm"), 
              method = "lm", formula = y ~ poly(x, 1), color = "black", se = FALSE) +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(sd_site_labels)) +
  theme_classic() +
  labs(title = "Regression of reflectance derivative sd on log(melanin index)",
       x = "log(Melanin index)",
       y = "Standard deviation of derivatives") + 
  ylim(0, 0.25) + xlim(2.75, 4.75) +
  theme(legend.position = "none")

print(p)
save_pdf(p, "reflectance_mi_sd_regression.pdf", width = 10, height = 5)
```

## Correlation between absorbance derivative sd and melanin index

```{r plot-derivative-sd-mi-abs, fig.width=10, fig.height=5}
p <- ggplot(data = sd_combined, aes(x = log_mi, y = sd_abs, color = site)) + 
  geom_point(size = 0.8, alpha = 0.7) + 
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(sd_site_labels)) +
  theme_classic() +
  labs(title = "Correlation between absorbance derivative sd and melanin index",
       x = "log(Melanin index)",
       y = "Standard deviation of derivatives") + 
  ylim(0, 0.0055) + xlim(2.75, 4.75) +
  theme(legend.position = "none")

print(p)
save_pdf(p, "absorbance_mi_sd.pdf", width = 10, height = 5)
```

## Correlation between erythema index and melanin index by site

```{r ei-mi-correlation, fig.width=10, fig.height=5}
# Combine face and palm spectra
ei_mi_combined = bind_rows(
  face_spectrum %>% select(site, mi, ei),
  palm_spectrum %>% select(site, mi, ei)
)

# Calculate n for each site
ei_mi_site_n <- ei_mi_combined %>%
  group_by(site) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
ei_mi_site_labels <- setNames(ei_mi_site_n$label, ei_mi_site_n$site)

p <- ggplot(data = ei_mi_combined, aes(x = mi, y = ei, color = site)) + 
  geom_point(size = 0.8, alpha = 0.7) + 
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(ei_mi_site_labels)) +
  theme_classic() +
  labs(title = "Correlation between erythema index and melanin index",
       x = "Melanin index",
       y = "Erythema index") + 
  xlim(0, 120) + ylim(10, 55) +
  theme(legend.position = "none")

print(p)
save_pdf(p, "ei_mi_correlation.pdf", width = 10, height = 5)
```

```{r palmei-facemi-correlation, fig.width=4, fig.height=4, out.width="50%"}
palm_spectrum$face_mi = face_spectrum$mi[match(palm_spectrum$C, face_spectrum$C)]
p <- ggplot(data = palm_spectrum) + geom_point(aes(face_mi, ei), color = "purple", size = 0.8) + theme_classic() +
  labs(title = paste0("Palm EI vs Face MI (n=", nrow(palm_spectrum), ")"),
       x = "Face Melanin index",
       y = "Palm Erythema index") + xlim(0, 120) + ylim(10, 55)

print(p)
save_pdf(p, "palm_ei_face_mi_correlation.pdf", width = 4, height = 4)
```

## Correlation between erythema index variability and melanin index by site

- EI variability is measured by the standard deviation of EIs within a sliding window of MI values. The window size is set to 20 MI units, and the step size is 1 MI unit.
  - For each center MI value in the sequence, all EI values corresponding to MI values within the window (center MI Â± 10) are collected, and their standard deviation is computed.
  - The center MI values range from the 1st to the 99th percentile of observed MI values.

```{r ei-sd, fig.width=10, fig.height=5}
window_size = 20 # melanin index units
step_size = 1 # melanin index units
# face
face_mi_seq = seq(floor(quantile(face_spectrum$mi, probs = 0.01)), floor(quantile(face_spectrum$mi, probs = 0.99)), by = step_size)
face_ei_sd = sapply(face_mi_seq, function(mi_val) {
  window_data = face_spectrum %>% filter(mi >= (mi_val - window_size/2) & mi < (mi_val + window_size/2))
  sd(window_data$ei)
})
face_ei_sd_df = data.frame(site = "Forehead/Cheek", mi = face_mi_seq, ei_sd = face_ei_sd)

# palm
palm_mi_seq = seq(floor(quantile(palm_spectrum$mi, probs = 0.01)), ceiling(quantile(palm_spectrum$mi, probs = 0.99)), by = step_size)
palm_ei_sd = sapply(palm_mi_seq, function(mi_val) {
  window_data = palm_spectrum %>% filter(mi >= (mi_val - window_size/2) & mi < (mi_val + window_size/2))
  sd(window_data$ei)
})
palm_ei_sd_df = data.frame(site = "Palm", mi = palm_mi_seq, ei_sd = palm_ei_sd)
max_mi_palm = palm_ei_sd_df$mi[which.max(palm_ei_sd_df$ei_sd)]

# Combine for faceted plot
ei_sd_combined = bind_rows(face_ei_sd_df, palm_ei_sd_df)

# Calculate n for each site (original data for context)
ei_sd_site_n <- data.frame(
  site = c("Forehead/Cheek", "Palm"),
  n = c(nrow(face_spectrum), nrow(palm_spectrum))
) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
ei_sd_site_labels <- setNames(ei_sd_site_n$label, ei_sd_site_n$site)

p <- ggplot(data = ei_sd_combined, aes(x = mi, y = ei_sd, color = site)) + 
  geom_line() + 
  geom_vline(data = data.frame(site = "Palm", xint = max_mi_palm), 
             aes(xintercept = xint), linetype = "dashed", color = "red") +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(ei_sd_site_labels)) +
  theme_classic() +
  labs(title = "Correlation between erythema index sd and melanin index",
       x = "Melanin index",
       y = "Erythema index standard deviation") + 
  xlim(0, 120) +
  theme(legend.position = "none")

print(p)
save_pdf(p, "ei_sd_mi_correlation.pdf", width = 10, height = 5)
```

```{r palmei-facemi-sd, fig.width=4, fig.height=4, out.width="50%"}
face_mi_seq = seq(floor(quantile(palm_spectrum$face_mi, probs = 0.01)), ceiling(quantile(palm_spectrum$face_mi, probs = 0.99)), by = step_size)
palm_ei_sd = sapply(face_mi_seq, function(mi_val) {
  window_data = palm_spectrum %>% filter(face_mi >= (mi_val - window_size/2) & face_mi < (mi_val + window_size/2))
  sd(window_data$ei)
})
palm_ei_sd_df = data.frame(mi = face_mi_seq, ei_sd = palm_ei_sd)
max_mi = palm_ei_sd_df$mi[which.max(palm_ei_sd_df$ei_sd)]
p <- ggplot(data = palm_ei_sd_df) + geom_line(aes(mi, ei_sd), color = "purple") + theme_classic() +
  labs(title = "Palm EI vs Face MI",
       x = "Face Melanin index",
       y = "Palm Erythema index standard deviation") + xlim(0, 120) +
  geom_vline(xintercept = max_mi, linetype = "dashed", color = "red") +
  annotate("text", x = max_mi, y = 4, label = paste("MI =", round(max_mi, 1)), 
           hjust = -0.1, vjust = -0.5, color = "red", size = 3.5)

print(p)
save_pdf(p, "palm_ei_face_mi_sd_correlation.pdf", width = 4, height = 4)
```
