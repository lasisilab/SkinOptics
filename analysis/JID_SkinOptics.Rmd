---
title: "Skin Optics Analysis based on ISSA Data"
author: "Junhui He and Tina Lasisi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Load required libraries
library(knitr)
library(tidyverse)
library(scales)
library(dplyr)
library(openxlsx)
library(KernSmooth)
library(here)
library(ggpubr)
library(ggstatsplot)
library(lme4)
library(broom.mixed)  # tidy mixed model outputs
library(ggeffects)    # predicted lines + CI


# Set global chunk options for the document
knitr::opts_chunk$set(
  echo = FALSE,        # Don't show code in output
  include = TRUE,      # Include output
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Don't show warnings
  message = FALSE,     # Don't show messages
  fig.retina = 2,      # Higher resolution figures
  fig.width = 8,       # Default figure width
  fig.height = 6,      # Default figure height
  out.width = "100%",  # Full width in HTML output
  autodep = TRUE       # Automatic dependency tracking for cached chunks
)

# Define output directory
OUTPUT_DIR <- here::here("output")

# Helper function to save plots to PDF
save_pdf <- function(plot_obj, filename, width = 10, height = 5, dir = OUTPUT_DIR) {
  filepath <- file.path(dir, filename)
  ggsave(filename = filepath, plot = plot_obj, width = width, height = height, device = "pdf")
  invisible(filepath)
}
```

```{r util_plot_functions, include=FALSE}
# =============================================================================
# REUSABLE UTILITY FUNCTIONS
# =============================================================================

# Format p-values (handles very small values)
format_pval <- function(p) {
  if (p < 2.2e-16) {
    return("p < 2.2e-16")
  } else {
    return(sprintf("p = %.2e", p))
  }
}

# Extract regression statistics from an lm object
get_reg_stats <- function(model) {
  summ <- summary(model)
  list(
    r2 = summ$r.squared,
    slope = coef(model)[2],
    intercept = coef(model)[1],
    p = summ$coefficients[2, 4]
  )
}

# Create annotation label from regression stats
make_annotation_label <- function(stats, slope_digits = 2) {
  sprintf("slope = %.*f\nRÂ² = %.3f\n%s", 
          slope_digits, stats$slope, stats$r2, format_pval(stats$p))
}

# Run regression and return stats for both face and palm
run_faceted_regression <- function(data_face, data_palm, formula, log_transform = FALSE) {
  if (log_transform) {
    # For log-log regression, we need to transform the formula
    # Assumes formula is y ~ x where we want log(y) ~ log(x)
    reg_face <- lm(formula, data = data_face)
    reg_palm <- lm(formula, data = data_palm)
  } else {
    reg_face <- lm(formula, data = data_face)
    reg_palm <- lm(formula, data = data_palm)
  }
  
  list(
    face = get_reg_stats(reg_face),
    palm = get_reg_stats(reg_palm),
    face_model = reg_face,
    palm_model = reg_palm
  )
}

# Create annotation dataframe for faceted plots
make_facet_annotations <- function(face_stats, palm_stats, x_pos, y_pos, slope_digits = 2) {
  data.frame(
    site = c("Forehead/Cheek", "Palm"),
    label = c(
      make_annotation_label(face_stats, slope_digits),
      make_annotation_label(palm_stats, slope_digits)
    ),
    x = x_pos,
    y = y_pos
  )
}

# Standard faceted scatter plot with regression line and annotations
plot_faceted_scatter <- function(data, x_var, y_var, annotation_df, 
                                  site_labels, title, x_lab, y_lab,
                                  log_x = FALSE, log_y = FALSE,
                                  colors = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) {
  p <- ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]], color = site)) +
    geom_point(size = 0.8, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE) +
    scale_color_manual(values = colors) +
    facet_wrap(~site, nrow = 1, labeller = as_labeller(site_labels)) +
    geom_text(data = annotation_df, aes(x = x, y = y, label = label),
              hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
    theme_classic() +
    labs(title = title, x = x_lab, y = y_lab) +
    theme(legend.position = "none")
  
  if (log_x) {
    p <- p + scale_x_log10(breaks = c(20, 30, 50, 100))
  }
  if (log_y) {
    p <- p + scale_y_log10()
  }
  
  return(p)
}

# Print regression summary with custom header
print_reg_summary <- function(model, header = "Regression Summary") {
  cat(paste0("=== ", header, " ==="), "\n")
  print(summary(model))
  cat("\n")
}

# Single scatter plot with regression line and annotation
plot_single_scatter <- function(data, x_var, y_var, stats, 
                                 title, x_lab, y_lab, color = "pink",
                                 smooth_color = "darkred",
                                 log_x = FALSE, log_y = FALSE,
                                 annotation_x = NULL, annotation_y = NULL,
                                 slope_digits = 3) {
  
  annotation_label <- make_annotation_label(stats, slope_digits)
  
  # Set default annotation position if not provided
  if (is.null(annotation_x)) annotation_x <- max(data[[x_var]], na.rm = TRUE) * 0.95
  if (is.null(annotation_y)) annotation_y <- max(data[[y_var]], na.rm = TRUE) * 0.95
  
  p <- ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]])) +
    geom_point(color = color, size = 0.8, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, color = smooth_color) +
    annotate("text", x = annotation_x, y = annotation_y, label = annotation_label,
             hjust = 1, vjust = 1, size = 3, color = "black") +
    theme_classic() +
    labs(title = title, x = x_lab, y = y_lab)
  
  if (log_x) {
    p <- p + scale_x_log10(breaks = c(20, 30, 50, 100))
  }
  if (log_y) {
    p <- p + scale_y_log10()
  }
  
  return(p)
}
```

# Clarifications

- Melanin index (MI) is calculated from skin reflectance at 680 nm, where $R_{680}$ is the measured reflectance percentage (0-100):
  - $$MI = -100 \times \log_{10}(R_{680} / 100)$$
  - This is equivalent to the standard formula $MI = 100 \times \log_{10}(1/R)$, where $R$ is reflectance as a decimal (0-1)
  - Internally, this is computed by first calculating absorbance ($A_{680} = -\log_{10}(R_{680} / 100)$), then multiplying by 100

- Erythema index (EI) is calculated as: $$EI = 100 \times \log_{10}\left(\frac{R_{680}}{(R_{550} + R_{560})/2}\right)$$ where $R_{550}$, $R_{560}$, and $R_{680}$ are the reflectance percentages at 550 nm, 560 nm, and 680 nm, respectively.

- EI variability is measured by the standard deviation of EIs within a sliding window of MI values. The window size is set to 20 MI units, and the step size is 1 MI unit.
  - For each center MI value in the sequence, all EI values corresponding to MI values within the window (center MI $\pm$ 10) are collected, and their standard deviation is computed.
  - The center MI values range from the 1st to the 99th percentile of observed MI values.

- FACE site refers to Forehead or Cheek, while PALM site refers to the palm of the hand. 

- Representative FACE MI: 
  - For each subject, the FACE MI is given by the Forehead MI if the Forehead MI is available; otherwise, it is the Cheek MI.
  - For subjects with multiple measurements at the same FACE site, we randomly select one measurement.
  - Each subject has only one representative FACE reflectance spectra.

- First derivatives of skin spectra are estimated using local polynomial regression with bandwidth selected by the dpill function, scaled by a factor of 0.7.

- Eumelanin class are defined based on melanin index ranges as follows:
  - Low: $MI < 25$
  - Intermediate low: $25 \leq MI < 50$
  - Intermediate: $50 \leq MI < 75$
  - Intermediate high: $75 \leq MI < 100$
  - High: $MI \geq 100$

- The pdf files generated in this analysis are saved in the "output" directory.

# Visualizations

```{r load_issa}
# Load the ISSA skin spectrum reflectance data
issa_path <- here::here("data", "ISSA_17_Jan_2025_Yan_Lu.xlsx")
issa_code <- read.xlsx(issa_path, sheet = 1)
issa_data <- read.xlsx(issa_path, sheet = 2)

# Extract the skin spectrum data
issa <- issa_data[10:nrow(issa_data), ] # 360 nm: 13rd column, 780 nm: 55th column
colnames(issa) <- issa_data[9, ]

# Define body site codes and names
body_codes = as.character(1:12)
body_names = c("Back of Hand", "Cheek", "Cheek bone", "Chin", "Ear Lobe", "Forehead", "Inner arm", "Neck", "Nose tip", "Outer arm", "Palm", "Ring finger")
issa$G = body_names[as.numeric(issa$G)]
```

```{r compute}
# compute melanin index and erythema index
reflectance_to_absorbance <- function(reflectance) {
  -log10(reflectance / 100)
}

wavelengths = seq(400, 700, by=10)
reflectance = issa %>% dplyr::select(`400`:`700`)
colnames(reflectance) = paste0("R", wavelengths)
# calculate absorbance
absorbance = as.data.frame(lapply(reflectance, reflectance_to_absorbance))
colnames(absorbance) = paste0("A", wavelengths)
spectrum = cbind(issa %>% dplyr::select(A, C, G), reflectance, absorbance)
# calculate melanin index and erythema index
spectrum = spectrum %>% mutate(mi = 100 * `A680`,
                               ei = 100 * log10(`R680` / ((`R550` + `R560`)/2)))
colnames(spectrum)[3] = "site" # rename G to site
# extract face and palm spectra
face_ids = unique(issa$C[issa$G %in% c("Forehead", "Cheek")])

# Check face data before deduplication
face_temp = spectrum %>% filter(site %in% c("Forehead", "Cheek"))
cat("Face readings before deduplication:", nrow(face_temp), "\n")
cat("Unique individuals with face readings:", n_distinct(face_temp$C), "\n")

# Deduplicate face data: prioritize Forehead over Cheek, one reading per person
face_spectrum = face_temp %>%
  arrange(C, site) %>%  # "Cheek" comes before "Forehead" alphabetically, so reverse
  mutate(site_priority = if_else(site == "Forehead", 1, 2)) %>%
  arrange(C, site_priority) %>%
  group_by(C) %>%
  slice(1) %>%
  ungroup() %>%
  select(-site_priority) %>%
  mutate(site = "Forehead/Cheek")

cat("Face readings after deduplication:", nrow(face_spectrum), "\n")

# Check for duplicates and deduplicate palm data (same as face)
palm_temp = spectrum %>% filter(C %in% face_ids, site == "Palm")
cat("Palm readings before deduplication:", nrow(palm_temp), "\n")
cat("Unique individuals with palm readings:", n_distinct(palm_temp$C), "\n")

# Deduplicate: one palm reading per person
palm_spectrum = palm_temp %>%
  group_by(C) %>%
  slice_sample(n = 1) %>%
  ungroup()

cat("Palm readings after deduplication:", nrow(palm_spectrum), "\n")
```


```{r spectra_plot_functions}
# ==============================================================================
# SPECTRA PLOTTING FUNCTIONS
# ==============================================================================

#' Generate skin reflectance spectra plot
#' 
#' Creates a plot showing reflectance spectra colored by melanin index
#' 
#' @param data 
#' @return A ggplot object
PlotReflectance <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>% 
    # Convert to long format
    pivot_longer(cols = matches("^R[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "reflectance") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
  
  plot <- ggplot(data_long, aes(x = wavelength, y = reflectance, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#ede0cc"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    labs(
      x = "Wavelength (nm)",
      y = "Reflectance percentage of skin",
      color = "Melanin index"
    ) +
    guides(color = guide_colorbar(reverse = TRUE)) # +
    # Highlight the region used for melanin index calculation
    # geom_vline(xintercept = 680, color = "#ff0000")
  
  return(plot)
}

#' Generate skin absorbance spectra plot
#' 
#' Creates a plot showing absorbance spectra colored by melanin index
#' 
#' @param data 
#' @return A ggplot object
PlotAbsorbance <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>% 
    # Convert to long format
    pivot_longer(cols = matches("^A[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "absorbance") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
  
  plot <- ggplot(data_long, aes(x = wavelength, y = absorbance, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#ede0cc"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    labs(
      x = "Wavelength (nm)",
      y = "Absorbance of skin",
      color = "Melanin index"
    ) +
    guides(color = guide_colorbar(reverse = TRUE)) +
    # Highlight the region used for melanin index calculation
    geom_vline(xintercept = 680, color = "#ff0000")
  
  return(plot)
}
```

```{r plot-derivatives}
# plot the first derivatives
PlotDerivative <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>%
    # Convert to long format
    pivot_longer(cols = matches("^[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "delta") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
    
  plot <- ggplot(data_long, aes(x = wavelength, y = delta, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    geom_hline(yintercept = 0, color = "black") +
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#ede0cc"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    guides(color = guide_colorbar(reverse = TRUE))
  
  return(plot)
}
```

```{r derivatives-face, cache=TRUE}

face_reflectance = as.matrix(face_spectrum %>% dplyr::select(`R400`:`R700`))
face_absorbance = as.matrix(face_spectrum %>% dplyr::select(`A400`:`A700`))

drv_facer = t(apply(face_reflectance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_facer) = wavelengths
drv_facer_df = as.data.frame(drv_facer) %>% mutate(A = face_spectrum$A, mi = face_spectrum$mi)

drv_facea = t(apply(face_absorbance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_facea) = wavelengths
drv_facea_df = as.data.frame(drv_facea) %>% mutate(A = face_spectrum$A, mi = face_spectrum$mi)
```

```{r outliers}
# remove outliers
outlier_index = which(drv_facer_df$`700`>1)
face_spectrum = face_spectrum[-outlier_index, ]
drv_facer = drv_facer[-outlier_index, ]
drv_facea = drv_facea[-outlier_index, ]
drv_facer_df = drv_facer_df[-outlier_index, ]
drv_facea_df = drv_facea_df[-outlier_index, ]


plot_drv_facer = PlotDerivative(drv_facer_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin reflectance",
      title = "First derivatives of skin reflectance",
      color = "Melanin index"
    )

plot_drv_facea = PlotDerivative(drv_facea_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin absorbance",
      title = "First derivatives of skin absorbance",
      color = "Melanin index"
    )
```

```{r derivatives-palm, fig.height=5, cache=TRUE}
palm_reflectance = as.matrix(palm_spectrum %>% dplyr::select(`R400`:`R700`))
palm_absorbance = as.matrix(palm_spectrum %>% dplyr::select(`A400`:`A700`))

drv_palmr = t(apply(palm_reflectance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_palmr) = wavelengths
drv_palmr_df = as.data.frame(drv_palmr) %>% mutate(A = palm_spectrum$A, C = palm_spectrum$C, mi = palm_spectrum$mi)
plot_drv_palmr = PlotDerivative(drv_palmr_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin reflectance",
      title = "First derivatives of skin reflectance",
      color = "Melanin index"
    )

drv_palma = t(apply(palm_absorbance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials
colnames(drv_palma) = wavelengths
drv_palma_df = as.data.frame(drv_palma) %>% mutate(A = palm_spectrum$A, C = palm_spectrum$C, mi = palm_spectrum$mi)
plot_drv_palma = PlotDerivative(drv_palma_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin absorbance",
      title = "First derivatives of skin absorbance",
      color = "Melanin index"
    )
```

```{r face mi}
# calculate representative face melanin index for each subject
face_ids = unique(issa$C[issa$G %in% c("Forehead", "Cheek")])
spectrum_filtered = spectrum %>% filter(C %in% face_ids)
spectrum_filtered$face_mi = NaN
for (id in face_ids) {
  spectrum_id = spectrum_filtered %>% filter(C == id)
  if (any(spectrum_id$site == "Forehead")) {
    face_mi = mean(spectrum_id$mi[spectrum_id$site == "Forehead"], na.rm = TRUE)
  } else {
    face_mi = mean(spectrum_id$mi[spectrum_id$site == "Cheek"], na.rm = TRUE)
  }
  spectrum_filtered$face_mi[spectrum_filtered$C == id] = face_mi
}

# define eumelanin class based on representative face melanin index
eumelanin_class_person = cut(spectrum_filtered$face_mi, breaks=c(0, 25, 50, 75, 100, 200))
eumelanin_class_person = factor(eumelanin_class_person, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high", "High"))

site_info = data.frame(subject = spectrum_filtered$C,
                       site = spectrum_filtered$site,
                       eumelanin_class = eumelanin_class_person,
                       face_mi = spectrum_filtered$face_mi)
```

## Distribution of melanin index by site


```{r sample distribution, fig.width=4, fig.height=7, out.width="50%"}
# distribution of melanin index for Forehead, Cheek, and palm
facepalm_spectrum = rbind(face_spectrum, palm_spectrum)

# Verify no duplicates per site
cat("\nFinal data summary:\n")
cat("Face: n =", nrow(face_spectrum), "| Unique individuals:", n_distinct(face_spectrum$C), "\n")
cat("Palm: n =", nrow(palm_spectrum), "| Unique individuals:", n_distinct(palm_spectrum$C), "\n")
cat("Combined: n =", nrow(facepalm_spectrum), "\n")

# Calculate n for each site
mi_site_n <- facepalm_spectrum %>%
  group_by(site) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
mi_site_labels <- setNames(mi_site_n$label, mi_site_n$site)

p <- ggplot(facepalm_spectrum, aes(x = mi, fill = site)) +
  geom_histogram(alpha = 0.7, position = "identity", binwidth = 5) +
  labs(x = "Melanin index", y = "Count", fill = "Site", 
       title = "Distribution of Melanin Index by Site") +
  xlim(0, 120) +
  scale_fill_brewer(palette = "Set2") +
  facet_wrap(~site, ncol = 1, labeller = as_labeller(mi_site_labels)) +
  theme_classic() +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "mi_distribution.pdf", width = 4, height = 7)
#ggsave("output/mi_distribution.png", plot = p, width = 4, height = 7, dpi = 300)
```

## Unique subjects per site across representative face melanin index bins (Heatmap)


```{r heatmap, fig.width=12, fig.height=6}
# 1) Cut mi into 10 equal-width bins (adjust breaks as needed)
df_bins <- site_info %>%
  mutate(mi_bin = cut(face_mi, breaks = seq(0, 130, by = 10))) %>%
  count(site, mi_bin, name = "n")

df_bins <- df_bins %>%
  tidyr::complete(site, mi_bin, fill = list(n = 0))

# 3) Calculate row totals
row_totals <- df_bins %>%
  group_by(site) %>%
  summarise(total = sum(n))

# 4) Add row totals as new column with label
df_bins_with_totals <- df_bins %>%
  left_join(row_totals, by = "site") %>%
  mutate(site_label = paste0(site, " (n=", total, ")"))

# 2) Heatmap with site labels showing totals
p <- ggplot(df_bins_with_totals, aes(x = mi_bin, y = site_label, fill = n)) +
  geom_tile(color = "white") +
  geom_text(aes(label = n), color = "white", size = 3) +
  scale_fill_viridis_c(option = "viridis") +
  labs(x = "Face MI, binned in 10-unit increments", y = "Site", fill = "Subject",
       title = "Unique subjects per site across 10-unit face MI bins") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

print(p)
save_pdf(p, "heatmap.pdf", width = 12, height = 6)
```

```{r eumelanin-class}
eumelanin_class_face = cut(face_spectrum$mi, breaks=c(0, 25, 50, 75, 100, 150))
eumelanin_class_face = factor(eumelanin_class_face, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high", "High"))
face_spectrum$class = eumelanin_class_face
drv_facer_df$class = eumelanin_class_face
drv_facea_df$class = eumelanin_class_face

eumelanin_class_palm = cut(palm_spectrum$mi, breaks=c(0, 25, 50, 75, 100)) # no "High" class for palm
eumelanin_class_palm = factor(eumelanin_class_palm, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high"))
palm_spectrum$palm_class = eumelanin_class_palm
drv_palmr_df$palm_class = eumelanin_class_palm
drv_palma_df$palm_class = eumelanin_class_palm

palm_spectrum$face_class = eumelanin_class_face[match(palm_spectrum$C, face_spectrum$C)]
drv_palmr_df$face_class = palm_spectrum$face_class
drv_palma_df$face_class = palm_spectrum$face_class

# report the table of the number of subjects in each class
kable(table(eumelanin_class_face), col.names = c("Eumelanin class", "Number of subjects"), caption = "Number of subjects in each eumelanin class (Forehead/Cheek)")
kable(table(eumelanin_class_palm), col.names = c("Eumelanin class", "Number of subjects"), caption = "Number of subjects in each eumelanin class (Palm)")
```

## Reflectance by eumelanin class

### Face reflectance by face eumelanin class

```{r plot-raw-reflectance-by-class-face, fig.width=12, fig.height=4}
# Calculate n for each class
face_class_n <- face_spectrum %>%
  group_by(class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(class, "\n(n=", n, ")"))
face_class_labels <- setNames(face_class_n$label, face_class_n$class)

p_raw_face <- PlotReflectance(face_spectrum) + 
  facet_wrap(~class, nrow = 1, labeller = as_labeller(face_class_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Reflectance",
    title = "Face reflectance by face eumelanin class",
    color = "Face melanin index"
  ) + 
  ylim(0, 75) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank())

print(p_raw_face)
save_pdf(p_raw_face, "reflectance_face.pdf", width = 12, height = 4)
```

### Palm reflectance by palm eumelanin class

```{r plot-raw-reflectance-by-class-palm, fig.width=12, fig.height=4}
# Calculate n for each palm class
palm_class_n <- palm_spectrum %>%
  group_by(palm_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(palm_class, "\n(n=", n, ")"))
palm_class_labels <- setNames(palm_class_n$label, palm_class_n$palm_class)

p <- PlotReflectance(palm_spectrum) + 
  facet_wrap(~palm_class, nrow = 1, labeller = as_labeller(palm_class_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Reflectance",
    title = "Palm reflectance by palm eumelanin class",
    color = "Palm melanin index"
  ) + 
  ylim(0, 75) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "reflectance_palm.pdf", width = 12, height = 4)
```

### Palm reflectance for corresponding face eumelanin class
```{r plot-raw-reflectance-by-class-palm-face, fig.width=12, fig.height=4}
# Calculate n for each face class (for palm spectra)
palm_faceclass_n <- palm_spectrum %>%
  group_by(face_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(face_class, "\n(n=", n, ")"))
palm_faceclass_labels <- setNames(palm_faceclass_n$label, palm_faceclass_n$face_class)

p_raw_palm_face <- PlotReflectance(palm_spectrum) + 
  facet_wrap(~face_class, nrow = 1, labeller = as_labeller(palm_faceclass_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Reflectance",
    title = "Palm reflectance for corresponding face eumelanin class",
    color = "Face melanin index"
  ) + 
  ylim(0, 75) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank())

print(p_raw_palm_face)
save_pdf(p_raw_palm_face, "reflectance_palm_face.pdf", width = 12, height = 4)
```

## First derivatives of reflectance by eumelanin class

### Face reflectance derivatives by face eumelanin class

```{r plot-reflectance-by-class-face, fig.width=12, fig.height=4}
# Calculate n for each class (derivatives)
face_deriv_n <- drv_facer_df %>%
  group_by(class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(class, "\n(n=", n, ")"))
face_deriv_labels <- setNames(face_deriv_n$label, face_deriv_n$class)

p_deriv_face <- PlotDerivative(drv_facer_df) + 
  facet_wrap(~class, nrow = 1, labeller = as_labeller(face_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of face reflectance by face eumelanin class",
    color = "Face melanin index"
  ) + 
  ylim(-0.6, 0.8) +
  theme(legend.position = "bottom")

print(p_deriv_face)
save_pdf(p_deriv_face, "reflectance_derivative_face.pdf", width = 12, height = 4)
```

### Palm reflectance derivatives by palm eumelanin class

```{r plot-reflectance-by-class-palm, fig.width=12, fig.height=4}
# Calculate n for each palm class (derivatives)
palm_deriv_n <- drv_palmr_df %>%
  group_by(palm_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(palm_class, "\n(n=", n, ")"))
palm_deriv_labels <- setNames(palm_deriv_n$label, palm_deriv_n$palm_class)

p <- PlotDerivative(drv_palmr_df) + 
  facet_wrap(~palm_class, nrow = 1, labeller = as_labeller(palm_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of palm reflectance by palm eumelanin class",
    color = "Palm melanin index"
  ) + 
  ylim(-0.6, 0.8) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "reflectance_derivative_palm.pdf", width = 12, height = 4)
```

### palm reflectance derivatives by face eumelanin class

```{r plot-reflectance-by-class-palm-face, fig.width=12, fig.height=4}
# Calculate n for each face class (palm derivatives)
palm_deriv_faceclass_n <- drv_palmr_df %>%
  group_by(face_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(face_class, "\n(n=", n, ")"))
palm_deriv_faceclass_labels <- setNames(palm_deriv_faceclass_n$label, palm_deriv_faceclass_n$face_class)

p_deriv_palm_face <- PlotDerivative(drv_palmr_df) + 
  facet_wrap(~face_class, nrow = 1, labeller = as_labeller(palm_deriv_faceclass_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of palm reflectance for corresponding face eumelanin class",
    color = "Face melanin index"
  ) + 
  ylim(-0.6, 0.8) +
  theme(legend.position = "bottom")

print(p_deriv_palm_face)
save_pdf(p_deriv_palm_face, "reflectance_derivative_palm_face.pdf", width = 12, height = 4)
```

## Composite figure: face reflectance and derivatives by eumelanin class

```{r composite-reflectance-derivatives, fig.width=18, fig.height=6}
# Combine the four plots into a composite figure
composite_plot <- ggarrange(
  p_raw_face, p_deriv_face, p_raw_palm_face, p_deriv_palm_face,
  labels = c("a", "b", "c", "d"),
  ncol = 2, nrow = 2,
  common.legend = TRUE,
  legend = "bottom",
  align = "hv"
)

print(composite_plot)
save_pdf(composite_plot, "composite_reflectance_derivatives.pdf", width = 18, height = 7)
```

## First derivatives of absorbance by eumelanin class

### face absorbance derivatives by face eumelanin class

```{r plot-absorbance-by-class-face, fig.width=12, fig.height=4}
# Calculate n for each class (absorbance derivatives)
face_abs_deriv_n <- drv_facea_df %>%
  group_by(class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(class, "\n(n=", n, ")"))
face_abs_deriv_labels <- setNames(face_abs_deriv_n$label, face_abs_deriv_n$class)

p <- PlotDerivative(drv_facea_df) + 
  facet_wrap(~class, nrow = 1, labeller = as_labeller(face_abs_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of face absorbance by face eumelanin class",
    color = "Face melanin index"
  ) + 
  ylim(-0.02, 0.02) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "absorbance_derivative_face.pdf", width = 12, height = 4)
```

### palm absorbance derivatives by palm eumelanin class

```{r plot-absorbance-by-class-palm, fig.width=12, fig.height=4}
# Calculate n for each palm class (absorbance derivatives)
palm_abs_deriv_n <- drv_palma_df %>%
  group_by(palm_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(palm_class, "\n(n=", n, ")"))
palm_abs_deriv_labels <- setNames(palm_abs_deriv_n$label, palm_abs_deriv_n$palm_class)

p <- PlotDerivative(drv_palma_df) + 
  facet_wrap(~palm_class, nrow = 1, labeller = as_labeller(palm_abs_deriv_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of palm absorbance by palm eumelanin class",
    color = "Palm melanin index"
  ) + 
  ylim(-0.02, 0.02) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "absorbance_derivative_palm.pdf", width = 12, height = 4)
```

### Palm absorbance derivatives by face eumelanin class

```{r plot-absorbance-by-class-palm-face, fig.width=12, fig.height=4}
# Calculate n for each face class (palm absorbance derivatives)
palm_abs_deriv_faceclass_n <- drv_palma_df %>%
  group_by(face_class) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(face_class, "\n(n=", n, ")"))
palm_abs_deriv_faceclass_labels <- setNames(palm_abs_deriv_faceclass_n$label, palm_abs_deriv_faceclass_n$face_class)

p <- PlotDerivative(drv_palma_df) + 
  facet_wrap(~face_class, nrow = 1, labeller = as_labeller(palm_abs_deriv_faceclass_labels)) +
  labs(
    x = "Wavelength (nm)",
    y = "Derivative",
    title = "First derivatives of palm absorbance by face eumelanin class",
    color = "Palm melanin index"
  ) + 
  ylim(-0.02, 0.02) +
  theme(legend.position = "bottom")

print(p)
save_pdf(p, "absorbance_derivative_palm_face.pdf", width = 12, height = 4)
```

```{r derivative-sd-mi}
# calculate the standard deviations in derivatives for a spectra curve
# face
sd_ref_face = apply(drv_facer, MARGIN = 1, sd)
sd_abs_face = apply(drv_facea, MARGIN = 1, sd)
sd_face = data.frame(site = "Forehead/Cheek", sd_ref = sd_ref_face, sd_abs = sd_abs_face, mi = face_spectrum$mi) %>% mutate(log_mi = log(mi))
# palm
sd_ref_palm = apply(drv_palmr, MARGIN = 1, sd)
sd_abs_palm = apply(drv_palma, MARGIN = 1, sd)
sd_palm = data.frame(site = "Palm", sd_ref = sd_ref_palm, sd_abs = sd_abs_palm, mi = palm_spectrum$mi) %>% mutate(log_mi = log(mi))
```

## Correlation between reflectance derivative sd and melanin index (log-log)

A log-log regression tests for a power-law relationship between derivative variability and melanin content. The slope in log-log space represents the exponent of this power-law relationship.

```{r plot-derivative-sd-mi-ref-log, fig.width=10, fig.height=5}
# Combine face and palm data for faceted plotting
sd_combined = bind_rows(sd_face, sd_palm)

# Calculate n for each site
sd_site_n <- sd_combined %>%
  group_by(site) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
sd_site_labels <- setNames(sd_site_n$label, sd_site_n$site)

# Run log-log regressions
reg_face_log <- lm(log(sd_ref) ~ log(mi), data = sd_face)
reg_palm_log <- lm(log(sd_ref) ~ log(mi), data = sd_palm)

# Extract regression stats using helper function
face_stats <- get_reg_stats(reg_face_log)
palm_stats <- get_reg_stats(reg_palm_log)

# Print regression summaries
print_reg_summary(reg_face_log, "Log-log regression: log(sd_ref) ~ log(mi) - FACE")
print_reg_summary(reg_palm_log, "Log-log regression: log(sd_ref) ~ log(mi) - PALM")

# Create annotation data using helper function
annotation_df <- make_facet_annotations(face_stats, palm_stats, 
                                         x_pos = 90, 
                                         y_pos = max(sd_combined$sd_ref) * 0.9)

p <- ggplot(data = sd_combined, aes(x = mi, y = sd_ref, color = site)) + 
  geom_point(size = 0.8, alpha = 0.7) + 
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(sd_site_labels)) +
  geom_text(data = annotation_df, aes(x = x, y = y, label = label),
            hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
  theme_classic() +
  labs(title = "Derivative SD vs melanin index (log-log, reflectance)",
       x = "log(Melanin Index)",
       y = "log(Standard deviation of derivatives)") + 
  theme(legend.position = "none")

print(p)
save_pdf(p, "reflectance_mi_sd_log.pdf", width = 10, height = 5)
```

## Derivative peak and valley analysis (500-650 nm)

For each individual spectrum, we identify the peak (maximum) and valley (minimum) of the first derivative within the 500-650 nm wavelength range. This range captures the hemoglobin absorption features.

```{r peak-valley-calculation}
# Function to find peak and valley in derivative data within wavelength range
find_peak_valley <- function(deriv_row, wavelengths, wl_min = 500, wl_max = 650) {
  # Filter to wavelength range
  idx <- wavelengths >= wl_min & wavelengths <= wl_max
  wl_subset <- wavelengths[idx]
  deriv_subset <- deriv_row[idx]
  
  # Find peak (maximum) and valley (minimum)
  peak_idx <- which.max(deriv_subset)
  valley_idx <- which.min(deriv_subset)
  
  data.frame(
    peak_wavelength = wl_subset[peak_idx],
    peak_value = deriv_subset[peak_idx],
    valley_wavelength = wl_subset[valley_idx],
    valley_value = deriv_subset[valley_idx]
  )
}

# Calculate for face derivatives
face_peak_valley <- do.call(rbind, lapply(1:nrow(drv_facer), function(i) {
  find_peak_valley(drv_facer[i, ], wavelengths)
}))
face_peak_valley$mi <- face_spectrum$mi
face_peak_valley$id <- face_spectrum$C
face_peak_valley$site <- "Forehead/Cheek"

# Calculate for palm derivatives
palm_peak_valley <- do.call(rbind, lapply(1:nrow(drv_palmr), function(i) {
  find_peak_valley(drv_palmr[i, ], wavelengths)
}))
palm_peak_valley$mi <- palm_spectrum$mi
palm_peak_valley$id <- palm_spectrum$C
palm_peak_valley$site <- "Palm"

# Combine data
peak_valley_combined <- bind_rows(face_peak_valley, palm_peak_valley)

# Summary statistics
cat("Face derivative peak/valley summary (500-650 nm):\n")
cat("Peak wavelength - Mean:", round(mean(face_peak_valley$peak_wavelength), 1), 
    "SD:", round(sd(face_peak_valley$peak_wavelength), 1), "\n")
cat("Valley wavelength - Mean:", round(mean(face_peak_valley$valley_wavelength), 1), 
    "SD:", round(sd(face_peak_valley$valley_wavelength), 1), "\n")

cat("\nPalm derivative peak/valley summary (500-650 nm):\n")
cat("Peak wavelength - Mean:", round(mean(palm_peak_valley$peak_wavelength), 1), 
    "SD:", round(sd(palm_peak_valley$peak_wavelength), 1), "\n")
cat("Valley wavelength - Mean:", round(mean(palm_peak_valley$valley_wavelength), 1), 
    "SD:", round(sd(palm_peak_valley$valley_wavelength), 1), "\n")
```

### Distribution and comparison of valley and peak characteristics: Face vs Palm

This analysis compares derivative valley and peak wavelengths and values between forehead/cheek and palm using t-tests to determine if differences are statistically significant.

```{r peak-valley-distribution-comparison, fig.width=12, fig.height=12}
# Calculate n for labels (needed for other chunks)
pv_site_n <- peak_valley_combined %>%
  group_by(site) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
pv_site_labels <- setNames(pv_site_n$label, pv_site_n$site)

# Create separate datasets for each comparison
peak_wavelength_data <- peak_valley_combined %>%
  select(site, mi, peak_wavelength) %>%
  rename(value = peak_wavelength)

valley_wavelength_data <- peak_valley_combined %>%
  select(site, mi, valley_wavelength) %>%
  rename(value = valley_wavelength)

peak_value_data <- peak_valley_combined %>%
  select(site, mi, peak_value) %>%
  rename(value = peak_value)

valley_value_data <- peak_valley_combined %>%
  select(site, mi, valley_value) %>%
  rename(value = valley_value)

# Plot peak wavelength: Face vs Palm
p1 <- ggbetweenstats(
  data = peak_wavelength_data,
  x = site,
  y = value,
  type = "parametric",
  pairwise.display = "all",
  pairwise.annotation = "p.value",
  p.adjust.method = "none",
  plot.type = "box",
  package = "ggsci",
  palette = "default_jco",
  centrality.plotting = TRUE,
  results.subtitle = TRUE,
  ggplot.component = list(
    labs(title = "Peak Wavelength: Face vs Palm",
         x = "",
         y = "Wavelength (nm)")
  )
)

# Plot valley wavelength: Face vs Palm
p2 <- ggbetweenstats(
  data = valley_wavelength_data,
  x = site,
  y = value,
  type = "parametric",
  pairwise.display = "all",
  pairwise.annotation = "p.value",
  p.adjust.method = "none",
  plot.type = "box",
  package = "ggsci",
  palette = "default_jco",
  centrality.plotting = TRUE,
  results.subtitle = TRUE,
  ggplot.component = list(
    labs(title = "Valley Wavelength: Face vs Palm",
         x = "",
         y = "Wavelength (nm)")
  )
)

# Plot peak value: Face vs Palm
p3 <- ggbetweenstats(
  data = peak_value_data,
  x = site,
  y = value,
  type = "parametric",
  pairwise.display = "all",
  pairwise.annotation = "p.value",
  p.adjust.method = "none",
  plot.type = "box",
  package = "ggsci",
  palette = "default_jco",
  centrality.plotting = TRUE,
  results.subtitle = TRUE,
  ggplot.component = list(
    labs(title = "Peak Value: Face vs Palm",
         x = "",
         y = "Derivative value")
  )
)

# Plot valley value: Face vs Palm
p4 <- ggbetweenstats(
  data = valley_value_data,
  x = site,
  y = value,
  type = "parametric",
  pairwise.display = "all",
  pairwise.annotation = "p.value",
  p.adjust.method = "none",
  plot.type = "box",
  package = "ggsci",
  palette = "default_jco",
  centrality.plotting = TRUE,
  results.subtitle = TRUE,
  ggplot.component = list(
    labs(title = "Valley Value: Face vs Palm",
         x = "",
         y = "Derivative value")
  )
)

# Combine all four plots in a 2x2 grid
p_composite <- ggarrange(p1, p2, p3, p4, ncol = 2, nrow = 2, labels = c("a", "b", "c", "d"))
print(p_composite)
save_pdf(p_composite, "peak_valley_distribution_comparison.pdf", width = 12, height = 12)
```
The differences in peak and valley wavelengths and values between face and palm sites are not statistically significant.

### Peak/valley value vs melanin index (log-log)

Log-log regression tests whether the amplitude of derivative peak and valley values follow a power-law relationship with melanin content. Note that valley values are negative, so we use absolute values for the log transformation.

```{r peak-valley-value-vs-mi-log, fig.width=12, fig.height=10}
# Filter data for positive peak values and negative valley values
peak_face_pos <- face_peak_valley %>% filter(peak_value > 0)
peak_palm_pos <- palm_peak_valley %>% filter(peak_value > 0)
valley_face_neg <- face_peak_valley %>% filter(valley_value < 0)
valley_palm_neg <- palm_peak_valley %>% filter(valley_value < 0)

# Run log-log regressions for peak value
reg_face_peak_val <- lm(log(peak_value) ~ log(mi), data = peak_face_pos)
reg_palm_peak_val <- lm(log(peak_value) ~ log(mi), data = peak_palm_pos)
face_peak_val_stats <- get_reg_stats(reg_face_peak_val)
palm_peak_val_stats <- get_reg_stats(reg_palm_peak_val)

print_reg_summary(reg_face_peak_val, "Log-log: log(peak_value) ~ log(mi) - FACE")
print_reg_summary(reg_palm_peak_val, "Log-log: log(peak_value) ~ log(mi) - PALM")

# Create annotation for peak value plot
pv_peak_filtered <- peak_valley_combined %>% filter(peak_value > 0)
annotation_peak_val <- make_facet_annotations(face_peak_val_stats, palm_peak_val_stats,
                                               x_pos = 90, 
                                               y_pos = max(pv_peak_filtered$peak_value) * 0.9)

# Plot peak value vs MI (log-log)
p1 <- ggplot(pv_peak_filtered, 
             aes(x = mi, y = peak_value, color = site)) +
  geom_point(size = 0.8, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(pv_site_labels)) +
  geom_text(data = annotation_peak_val, aes(x = x, y = y, label = label),
            hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
  theme_classic() +
  labs(title = "Peak value vs melanin index (log-log)",
       x = "log(Melanin Index)",
       y = "log(Peak derivative value)") +
  theme(legend.position = "none")

# Run log-log regressions for valley value (absolute value since negative)
reg_face_valley_val <- lm(log(abs(valley_value)) ~ log(mi), data = valley_face_neg)
reg_palm_valley_val <- lm(log(abs(valley_value)) ~ log(mi), data = valley_palm_neg)
face_valley_val_stats <- get_reg_stats(reg_face_valley_val)
palm_valley_val_stats <- get_reg_stats(reg_palm_valley_val)

print_reg_summary(reg_face_valley_val, "Log-log: log(|valley_value|) ~ log(mi) - FACE")
print_reg_summary(reg_palm_valley_val, "Log-log: log(|valley_value|) ~ log(mi) - PALM")

# Create annotation for valley value plot
pv_valley_filtered <- peak_valley_combined %>% filter(valley_value < 0)
annotation_valley_val <- make_facet_annotations(face_valley_val_stats, palm_valley_val_stats,
                                                 x_pos = 90, 
                                                 y_pos = max(abs(pv_valley_filtered$valley_value)) * 0.9)

# Plot valley value vs MI (log-log) - use absolute value
p2 <- ggplot(pv_valley_filtered, 
             aes(x = mi, y = abs(valley_value), color = site)) +
  geom_point(size = 0.8, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(pv_site_labels)) +
  geom_text(data = annotation_valley_val, aes(x = x, y = y, label = label),
            hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
  theme_classic() +
  labs(title = "Valley value vs melanin index (log-log)",
       x = "log(Melanin Index)",
       y = "log(|Valley derivative value|)") +
  theme(legend.position = "none")

# Combine plots
p <- ggarrange(p1, p2, ncol = 1, nrow = 2, labels = c("a", "b"))
print(p)
save_pdf(p, "peak_valley_value_vs_mi_log.pdf", width = 12, height = 10)
```

### Delta (peak - valley) vs melanin index

The delta represents the amplitude of the hemoglobin absorption feature in the derivative spectrum - the difference between the peak and valley values.

```{r peak-valley-delta-calculation}
# Calculate delta for each individual (peak value - valley value)
peak_valley_combined <- peak_valley_combined %>%
  mutate(delta = peak_value - valley_value)

face_peak_valley <- face_peak_valley %>%
  mutate(delta = peak_value - valley_value)

palm_peak_valley <- palm_peak_valley %>%
  mutate(delta = peak_value - valley_value)

# Summary statistics
cat("Delta (peak - valley) summary:\n\n")
cat("Face:\n")
print(summary(face_peak_valley$delta))
cat("\nPalm:\n")
print(summary(palm_peak_valley$delta))
```

```{r peak-valley-delta-regression}
# --- FACE delta regression ---
cat("=== FACE: Delta (peak - valley) vs Melanin Index ===\n\n")
reg_face_delta <- lm(delta ~ mi, data = face_peak_valley)
print(summary(reg_face_delta))

# --- PALM delta regression ---
cat("\n\n=== PALM: Delta (peak - valley) vs Melanin Index ===\n\n")
reg_palm_delta <- lm(delta ~ mi, data = palm_peak_valley)
print(summary(reg_palm_delta))
```

### Delta vs melanin index (log-log)

The delta (peak minus valley) represents the amplitude of the hemoglobin absorption feature in the first derivative. Log-log regression tests whether this amplitude follows a power-law relationship with melanin content.

```{r peak-valley-delta-vs-mi-log, fig.width=12, fig.height=5}
# Run log-log regressions for delta
delta_face <- face_peak_valley %>% filter(delta > 0)
delta_palm <- palm_peak_valley %>% filter(delta > 0)

reg_face_delta_log <- lm(log(delta) ~ log(mi), data = delta_face)
reg_palm_delta_log <- lm(log(delta) ~ log(mi), data = delta_palm)

# Extract regression stats using helper function
face_stats <- get_reg_stats(reg_face_delta_log)
palm_stats <- get_reg_stats(reg_palm_delta_log)

# Print regression summaries
print_reg_summary(reg_face_delta_log, "Log-log regression: log(delta) ~ log(mi) - FACE")
print_reg_summary(reg_palm_delta_log, "Log-log regression: log(delta) ~ log(mi) - PALM")

# Create annotation data using helper function
pv_delta_filtered <- peak_valley_combined %>% filter(delta > 0)
annotation_delta <- make_facet_annotations(face_stats, palm_stats, 
                                            x_pos = 90, 
                                            y_pos = max(pv_delta_filtered$delta) * 0.9)

# Plot delta vs MI (log-log) - store as p1 for composite
p1 <- ggplot(pv_delta_filtered, 
            aes(x = mi, y = delta, color = site)) +
  geom_point(size = 0.8, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(pv_site_labels)) +
  geom_text(data = annotation_delta, aes(x = x, y = y, label = label),
            hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
  theme_classic() +
  labs(title = "Delta (peak - valley) vs melanin index (log-log)",
       x = "log(Melanin Index)",
       y = "log(Delta (peak - valley))") +
  theme(legend.position = "none")
```

## Absorbance derivative SD vs melanin index (log-log)

This log-log regression tests for a power-law relationship between absorbance derivative variability and melanin content.

```{r plot-derivative-sd-mi-abs-log, fig.width=10, fig.height=5}
# Run log-log regressions for absorbance SD
reg_face_abs_log <- lm(log(sd_abs) ~ log(mi), data = sd_face)
reg_palm_abs_log <- lm(log(sd_abs) ~ log(mi), data = sd_palm)

# Extract regression stats using helper function
face_stats <- get_reg_stats(reg_face_abs_log)
palm_stats <- get_reg_stats(reg_palm_abs_log)

# Print regression summaries
print_reg_summary(reg_face_abs_log, "Log-log regression: log(sd_abs) ~ log(mi) - FACE")
print_reg_summary(reg_palm_abs_log, "Log-log regression: log(sd_abs) ~ log(mi) - PALM")

# Create annotation data using helper function
annotation_abs <- make_facet_annotations(face_stats, palm_stats, 
                                          x_pos = 90, 
                                          y_pos = max(sd_combined$sd_abs) * 0.9)

p <- ggplot(data = sd_combined, aes(x = mi, y = sd_abs, color = site)) + 
  geom_point(size = 0.8, alpha = 0.7) + 
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(sd_site_labels)) +
  geom_text(data = annotation_abs, aes(x = x, y = y, label = label),
            hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
  theme_classic() +
  labs(title = "Derivative SD vs melanin index (log-log, absorbance)",
       x = "log(Melanin Index)",
       y = "log(Standard deviation of derivatives)") + 
  theme(legend.position = "none")

print(p)
save_pdf(p, "absorbance_mi_sd_log.pdf", width = 10, height = 5)
```

## Delta (680 nm - 555 nm) vs melanin index

The erythema index is based on the ratio of reflectance at 680 nm to the average reflectance at 550-560 nm (approximating 555 nm). Here we examine the raw reflectance difference (delta) between these wavelengths as a function of melanin index.

```{r reflectance-delta-calculation}
# Calculate reflectance delta: R680 - average(R550, R560)
# This represents the raw reflectance difference used in erythema index
face_spectrum <- face_spectrum %>%
  mutate(R555_approx = (R550 + R560) / 2,
         ref_delta = R680 - R555_approx)

palm_spectrum <- palm_spectrum %>%
  mutate(R555_approx = (R550 + R560) / 2,
         ref_delta = R680 - R555_approx)

# Combine for faceted plot
ref_delta_combined <- bind_rows(
  face_spectrum %>% select(site, mi, ref_delta, R680, R555_approx, C),
  palm_spectrum %>% select(site, mi, ref_delta, R680, R555_approx, C)
) %>%
  rename(id = C)

# Calculate n for each site
ref_delta_site_n <- ref_delta_combined %>%
  group_by(site) %>%
  summarise(n = n()) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
ref_delta_site_labels <- setNames(ref_delta_site_n$label, ref_delta_site_n$site)

# Summary statistics
cat("=== Delta (R680 - R555_approx) summary ===\n\n")
ref_delta_combined %>%
  group_by(site) %>%
  summarise(
    mean_delta = mean(ref_delta),
    sd_delta = sd(ref_delta),
    min_delta = min(ref_delta),
    max_delta = max(ref_delta),
    mean_R680 = mean(R680),
    mean_R555 = mean(R555_approx)
  ) %>%
  print()
```

### Delta R680-R555 vs melanin index

```{r reflectance-delta-vs-mi, fig.width=10, fig.height=5}
# Run linear regressions for annotation
reg_face_lin <- lm(ref_delta ~ mi, data = face_spectrum)
reg_palm_lin <- lm(ref_delta ~ mi, data = palm_spectrum)

# Extract regression stats using helper function
face_stats <- get_reg_stats(reg_face_lin)
palm_stats <- get_reg_stats(reg_palm_lin)

# Create annotation data using helper function
annotation_ref_lin <- make_facet_annotations(face_stats, palm_stats, 
                                              x_pos = 100, 
                                              y_pos = max(ref_delta_combined$ref_delta) * 0.95)

p <- ggplot(ref_delta_combined, aes(x = mi, y = ref_delta, color = site)) +
  geom_point(size = 0.8, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(ref_delta_site_labels)) +
  geom_text(data = annotation_ref_lin, aes(x = x, y = y, label = label),
            hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
  theme_classic() +
  labs(title = "Delta (R680 - R555) vs melanin index",
       x = "Melanin index",
       y = "Delta (R680 - R555)") +
  theme(legend.position = "none")

print(p)
save_pdf(p, "reflectance_delta_vs_mi.pdf", width = 10, height = 5)
```

### Log-transformed: Delta R680-R555 vs melanin index

Log-log regression tests whether the reflectance difference between 680 nm and ~555 nm follows a power-law relationship with melanin content. Note: only positive delta values can be log-transformed.

```{r reflectance-delta-vs-mi-log, fig.width=10, fig.height=6}
# Filter for positive deltas only (required for log transform)
delta_face_pos <- face_spectrum %>% filter(ref_delta > 0)
delta_palm_pos <- palm_spectrum %>% filter(ref_delta > 0)

cat("Face: ", nrow(delta_face_pos), " of ", nrow(face_spectrum), " have positive delta\n")
cat("Palm: ", nrow(delta_palm_pos), " of ", nrow(palm_spectrum), " have positive delta\n")

# Run log-log regressions
reg_face_delta <- lm(log(ref_delta) ~ log(mi), data = delta_face_pos)
reg_palm_delta <- lm(log(ref_delta) ~ log(mi), data = delta_palm_pos)

# Extract regression stats using helper function
face_stats <- get_reg_stats(reg_face_delta)
palm_stats <- get_reg_stats(reg_palm_delta)

# Print regression summaries
print_reg_summary(reg_face_delta, "Log-log regression: log(ref_delta) ~ log(mi) - FACE")
print_reg_summary(reg_palm_delta, "Log-log regression: log(ref_delta) ~ log(mi) - PALM")

# Filter combined data for plotting
ref_delta_filtered <- ref_delta_combined %>% filter(ref_delta > 0)

# Create annotation data using helper function
annotation_ref_delta <- make_facet_annotations(face_stats, palm_stats, 
                                                x_pos = 90, 
                                                y_pos = max(ref_delta_filtered$ref_delta) * 0.9)

p2 <- ggplot(ref_delta_filtered, aes(x = mi, y = ref_delta, color = site)) +
  geom_point(size = 0.8, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(ref_delta_site_labels)) +
  geom_text(data = annotation_ref_delta, aes(x = x, y = y, label = label),
            hjust = 1, vjust = 1, size = 3, color = "black", inherit.aes = FALSE) +
  theme_classic() +
  labs(title = "Delta (R680 - R555) vs melanin index (log-log)",
       x = "log(Melanin Index)",
       y = "log(Delta (R680 - R555))") +
  theme(legend.position = "none")

# Combine with peak-valley delta plot from previous chunk
p_composite <- ggarrange(p1, p2, ncol = 1, nrow = 2, labels = c("a", "b"))
print(p_composite)
save_pdf(p_composite, "delta_comparison_log.pdf", width = 10, height = 6)
```

### Mixed-effects models: Testing body site differences

We use mixed-effects models to test whether the relationship between melanin index and delta values differs by body site, accounting for repeated measures within individuals.

We tested whether anatomical site (forehead/cheek vs palm) modifies the logâlog relationship between melanin index (MI) and (i) peakâvalley derivative delta and (ii) reflectance delta (R680âR555), using linear mixed-effects models with a random intercept for subject. For each outcome, we compared a main-effects model (log_delta ~ log_mi + bodysite) to an interaction model (log_delta ~ log_mi * bodysite). A significant likelihood ratio test (LRT) indicates site-specific scaling (different slopes).

```{r delta-mixed-effects-models}
library(lme4)

# Helper function to report likelihood ratio test results
report_lrt <- function(m0, m1, outcome_label) {
  lrt <- anova(m0, m1)
  # second row is the interaction model
  chi2 <- lrt$Chisq[2]
  df   <- lrt$`Df`[2]
  p    <- lrt$`Pr(>Chisq)`[2]
  cat(sprintf("%s: LRT comparing interaction vs main-effects model: ÏÂ²(%d) = %.2f, %s\n\n",
              outcome_label, df, chi2, format_pval(p)))
}

# === PEAK-VALLEY DELTA MODELS ===
cat("=== Peak-Valley Delta: Testing body site effect ===\n\n")

# Filter positive deltas for log transformation
pv_delta_data <- peak_valley_combined %>% 
  filter(delta > 0) %>%
  mutate(log_delta = log(delta),
         log_mi = log(mi),
         bodysite = site)

# Model 0: Main effects only (log_delta ~ log_mi + bodysite)
m0_pv <- lmer(
  log_delta ~ log_mi + bodysite + (1 | id),
  data = pv_delta_data
)

# Model 1: Interaction effect (log_delta ~ log_mi * bodysite)
m1_pv <- lmer(
  log_delta ~ log_mi * bodysite + (1 | id),
  data = pv_delta_data
)

# Report likelihood ratio test
report_lrt(m0_pv, m1_pv, "Peakâvalley derivative Î")

# === REFLECTANCE DELTA (R680-R555) MODELS ===
cat("=== Reflectance Delta (R680-R555): Testing body site effect ===\n\n")

# Filter positive deltas for log transformation
ref_delta_data <- ref_delta_combined %>% 
  filter(ref_delta > 0) %>%
  mutate(log_delta = log(ref_delta),
         log_mi = log(mi),
         bodysite = site)

# Model 0: Main effects only
m0_ref <- lmer(
  log_delta ~ log_mi + bodysite + (1 | id),
  data = ref_delta_data
)

# Model 1: Interaction effect
m1_ref <- lmer(
  log_delta ~ log_mi * bodysite + (1 | id),
  data = ref_delta_data
)

# Report likelihood ratio test
report_lrt(m0_ref, m1_ref, "Reflectance Î (R680âR555)")
```

Anatomical site significantly modified the MIâÎ relationship for both peakâvalley derivative Î and reflectance Î (LRT comparing interaction vs main-effects models; see output above), indicating site-specific scaling rather than a simple constant offset.

```{r delta-predicted-lines, fig.width=8, fig.height=4}
library(ggeffects)

# Peakâvalley delta predicted lines
pred_pv <- ggpredict(m1_pv, terms = c("log_mi [all]", "bodysite"))
p_pv <- plot(pred_pv) +
  labs(title = "Predicted log(Î) vs log(MI) by anatomical site",
       x = "log(Melanin Index)", y = "Predicted log(Peakâvalley Î)")
print(p_pv)
save_pdf(p_pv, "predicted_lines_peakvalley_delta.pdf", width = 8, height = 4)

# Reflectance delta predicted lines
pred_ref <- ggpredict(m1_ref, terms = c("log_mi [all]", "bodysite"))
p_ref <- plot(pred_ref) +
  labs(title = "Predicted log(Î) vs log(MI) by anatomical site",
       x = "log(Melanin Index)", y = "Predicted log(R680âR555 Î)")
print(p_ref)
save_pdf(p_ref, "predicted_lines_reflectance_delta.pdf", width = 8, height = 4)
```

## Face erythema index vs face melanin index: Linear vs Log-log comparison

Comparing linear and log-log regressions to test which model better fits the relationship between face erythema index and face melanin content.

```{r faceei-facemi-comparison, fig.width=10, fig.height=5}
# === LINEAR REGRESSION ===
reg_face_ei_lin <- lm(ei ~ mi, data = face_spectrum)
face_ei_stats_lin <- get_reg_stats(reg_face_ei_lin)
print_reg_summary(reg_face_ei_lin, "Linear regression: face_ei ~ face_mi")

annotation_face_ei_lin <- make_annotation_label(face_ei_stats_lin, slope_digits = 3)

p1 <- ggplot(data = face_spectrum, aes(x = mi, y = ei)) + 
  geom_point(color = "pink", size = 0.8, alpha = 0.7) + 
  geom_smooth(method = "lm", se = TRUE, color = "darkred") +
  annotate("text", x = 110, y = 52, label = annotation_face_ei_lin,
           hjust = 1, vjust = 1, size = 3, color = "black") +
  theme_classic() +
  labs(title = paste0("Face EI vs Face MI - Linear (n=", nrow(face_spectrum), ")"),
       x = "Face Melanin index",
       y = "Face Erythema index") + 
  xlim(0, 120) + ylim(10, 55)

# === LOG-LOG REGRESSION ===
face_data_filtered <- face_spectrum %>% filter(ei > 0, mi > 0)
reg_face_ei_log <- lm(log(ei) ~ log(mi), data = face_data_filtered)
face_ei_stats_log <- get_reg_stats(reg_face_ei_log)
print_reg_summary(reg_face_ei_log, "Log-log regression: log(face_ei) ~ log(face_mi)")

annotation_face_ei_log <- make_annotation_label(face_ei_stats_log)

p2 <- ggplot(data = face_data_filtered, aes(x = mi, y = ei)) + 
  geom_point(color = "pink", size = 0.8, alpha = 0.7) + 
  geom_smooth(method = "lm", se = TRUE, color = "darkred") +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  annotate("text", x = 90, y = max(face_spectrum$ei) * 0.9, label = annotation_face_ei_log,
           hjust = 1, vjust = 1, size = 3, color = "black") +
  theme_classic() +
  labs(title = paste0("Face EI vs Face MI - Log-log (n=", nrow(face_data_filtered), ")"),
       x = "log(Face Melanin index)",
       y = "log(Face Erythema index)")

# Combine plots side by side
p <- ggarrange(p1, p2, ncol = 2, nrow = 1, labels = c("a", "b"))
print(p)
save_pdf(p, "face_ei_face_mi_comparison.pdf", width = 10, height = 5)
```

## Palm erythema index vs face melanin index: Linear vs Log-log comparison

Comparing linear and log-log regressions to test which model better fits the relationship between palm erythema index and face melanin content. This cross-site comparison may reveal systemic hemoglobin patterns.

```{r palmei-facemi-comparison, fig.width=10, fig.height=5}
# Ensure face_mi is set for palm_spectrum
palm_spectrum$face_mi = face_spectrum$mi[match(palm_spectrum$C, face_spectrum$C)]

# === LINEAR REGRESSION ===
reg_palm_ei_lin <- lm(ei ~ face_mi, data = palm_spectrum)
palm_ei_stats_lin <- get_reg_stats(reg_palm_ei_lin)
print_reg_summary(reg_palm_ei_lin, "Linear regression: palm_ei ~ face_mi")

annotation_palm_ei_lin <- make_annotation_label(palm_ei_stats_lin, slope_digits = 3)

p1 <- ggplot(data = palm_spectrum, aes(x = face_mi, y = ei)) + 
  geom_point(color = "steelblue", size = 0.8, alpha = 0.7) + 
  geom_smooth(method = "lm", se = TRUE, color = "darkblue") +
  annotate("text", x = 110, y = 52, label = annotation_palm_ei_lin,
           hjust = 1, vjust = 1, size = 3, color = "black") +
  theme_classic() +
  labs(title = paste0("Palm EI vs Face MI - Linear (n=", nrow(palm_spectrum), ")"),
       x = "Face Melanin index",
       y = "Palm Erythema index") + 
  xlim(0, 120) + ylim(10, 55)

# === LOG-LOG REGRESSION ===
palm_data_filtered <- palm_spectrum %>% filter(ei > 0, face_mi > 0)
reg_palm_ei_log <- lm(log(ei) ~ log(face_mi), data = palm_data_filtered)
palm_ei_stats_log <- get_reg_stats(reg_palm_ei_log)
print_reg_summary(reg_palm_ei_log, "Log-log regression: log(palm_ei) ~ log(face_mi)")

annotation_palm_ei_log <- make_annotation_label(palm_ei_stats_log)

p2 <- ggplot(data = palm_data_filtered, aes(x = face_mi, y = ei)) + 
  geom_point(color = "steelblue", size = 0.8, alpha = 0.7) + 
  geom_smooth(method = "lm", se = TRUE, color = "darkblue") +
  scale_x_log10(breaks = c(20, 30, 50, 100)) +
  scale_y_log10() +
  annotate("text", x = 90, y = max(palm_spectrum$ei) * 0.9, label = annotation_palm_ei_log,
           hjust = 1, vjust = 1, size = 3, color = "black") +
  theme_classic() +
  labs(title = paste0("Palm EI vs Face MI - Log-log (n=", nrow(palm_data_filtered), ")"),
       x = "log(Face Melanin index)",
       y = "log(Palm Erythema index)")

# Combine plots side by side
p <- ggarrange(p1, p2, ncol = 2, nrow = 1, labels = c("a", "b"))
print(p)
save_pdf(p, "palm_ei_face_mi_comparison.pdf", width = 10, height = 5)
```

## Correlation between erythema index variability and melanin index by site

- EI variability is measured by the standard deviation of EIs within a sliding window of MI values. The window size is set to 20 MI units, and the step size is 1 MI unit.
  - For each center MI value in the sequence, all EI values corresponding to MI values within the window (center MI Â± 10) are collected, and their standard deviation is computed.
  - The center MI values range from the 1st to the 99th percentile of observed MI values.

```{r ei-sd, fig.width=10, fig.height=5}
window_size = 20 # melanin index units
step_size = 1 # melanin index units
# face
face_mi_seq = seq(floor(quantile(face_spectrum$mi, probs = 0.01)), floor(quantile(face_spectrum$mi, probs = 0.99)), by = step_size)
face_ei_sd = sapply(face_mi_seq, function(mi_val) {
  window_data = face_spectrum %>% filter(mi >= (mi_val - window_size/2) & mi < (mi_val + window_size/2))
  sd(window_data$ei)
})
face_ei_sd_df = data.frame(site = "Forehead/Cheek", mi = face_mi_seq, ei_sd = face_ei_sd)

# palm
palm_mi_seq = seq(floor(quantile(palm_spectrum$mi, probs = 0.01)), ceiling(quantile(palm_spectrum$mi, probs = 0.99)), by = step_size)
palm_ei_sd = sapply(palm_mi_seq, function(mi_val) {
  window_data = palm_spectrum %>% filter(mi >= (mi_val - window_size/2) & mi < (mi_val + window_size/2))
  sd(window_data$ei)
})
palm_ei_sd_df = data.frame(site = "Palm", mi = palm_mi_seq, ei_sd = palm_ei_sd)
max_mi_palm = palm_ei_sd_df$mi[which.max(palm_ei_sd_df$ei_sd)]

# Combine for faceted plot
ei_sd_combined = bind_rows(face_ei_sd_df, palm_ei_sd_df)

# Calculate n for each site (original data for context)
ei_sd_site_n <- data.frame(
  site = c("Forehead/Cheek", "Palm"),
  n = c(nrow(face_spectrum), nrow(palm_spectrum))
) %>%
  mutate(label = paste0(site, "\n(n=", n, ")"))
ei_sd_site_labels <- setNames(ei_sd_site_n$label, ei_sd_site_n$site)

p <- ggplot(data = ei_sd_combined, aes(x = mi, y = ei_sd, color = site)) + 
  geom_line() + 
  geom_vline(data = data.frame(site = "Palm", xint = max_mi_palm), 
             aes(xintercept = xint), linetype = "dashed", color = "red") +
  scale_color_manual(values = c("Forehead/Cheek" = "pink", "Palm" = "steelblue")) +
  facet_wrap(~site, nrow = 1, labeller = as_labeller(ei_sd_site_labels)) +
  theme_classic() +
  labs(title = "Correlation between erythema index sd and melanin index",
       x = "Melanin index",
       y = "Erythema index standard deviation") + 
  xlim(0, 120) +
  theme(legend.position = "none")

print(p)
save_pdf(p, "ei_sd_mi_correlation.pdf", width = 10, height = 5)
```

```{r palmei-facemi-sd, fig.width=4, fig.height=4, out.width="50%"}
face_mi_seq = seq(floor(quantile(palm_spectrum$face_mi, probs = 0.01)), ceiling(quantile(palm_spectrum$face_mi, probs = 0.99)), by = step_size)
palm_ei_sd = sapply(face_mi_seq, function(mi_val) {
  window_data = palm_spectrum %>% filter(face_mi >= (mi_val - window_size/2) & face_mi < (mi_val + window_size/2))
  sd(window_data$ei)
})
palm_ei_sd_df = data.frame(mi = face_mi_seq, ei_sd = palm_ei_sd)
max_mi = palm_ei_sd_df$mi[which.max(palm_ei_sd_df$ei_sd)]
p <- ggplot(data = palm_ei_sd_df) + geom_line(aes(mi, ei_sd), color = "purple") + theme_classic() +
  labs(title = "Palm EI vs face MI",
       x = "Face Melanin index",
       y = "Palm Erythema index standard deviation") + xlim(0, 120) +
  geom_vline(xintercept = max_mi, linetype = "dashed", color = "red") +
  annotate("text", x = max_mi, y = 4, label = paste("MI =", round(max_mi, 1)), 
           hjust = -0.1, vjust = -0.5, color = "red", size = 3.5)

print(p)
save_pdf(p, "palm_ei_face_mi_sd_correlation.pdf", width = 4, height = 4)
```
