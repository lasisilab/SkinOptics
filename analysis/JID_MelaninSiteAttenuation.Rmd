---
title: "Objective, but not unbiased: accounting for melanin‑ and site-dependent attenuation
  in the erythema band"
author: "Junhui He"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Load required libraries
library(knitr)
library(patchwork)
library(tidyverse)
library(scales)
library(dplyr)
library(openxlsx)
library(KernSmooth)

# Set global chunk options for the document
knitr::opts_chunk$set(
  echo = FALSE,        # Don't show code in output
  include = TRUE,      # Include output
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Don't show warnings
  message = FALSE,     # Don't show messages
  fig.retina = 2,      # Higher resolution figures
  fig.width = 8,       # Default figure width
  fig.height = 6,      # Default figure height
  out.width = "100%"   # Full width in HTML output
)
```

# Clarifications

- Melanin index (MI) is calculated based on skin reflectance at 680 nm. Specifically, MI = -100 * log10(R680 / 100), where R680 is the reflectance percentage at 680 nm.

- FACE site refers to Forehead and Cheek, while PALM site refers to the Palm of the hand. 

- Representative FACE MI: 
  - For each subject, the FACE MI is given by the Forehead MI if the Forehead MI is available; otherwise, it is the Cheek MI.
  - For subjects with multiple measurements at the same FACE site, the average MI across those measurements is used.

- First derivatives of skin spectra are estimated using local polynomial regression with bandwidth selected by the dpill function, scaled by a factor of 0.7.

- Eumelanin classes are defined based on melanin index ranges as follows:
  - Low: MI < 25
  - Intermediate low: 25 ≤ MI < 50
  - Intermediate: 50 ≤ MI < 75
  - Intermediate high: 75 ≤ MI < 100
  - High: MI ≥ 100

# Visualizations

```{r load_issa}
# Load the ISSA skin spectrum reflectance data
# issa_path <- "G:/Phd/Colloborator/Tina Lasisi/Meta/ISSA_17_Jan_2025_Yan_Lu.xlsx"
issa_path <- "/Users/hjh/PhD/Meta/ISSA_17_Jan_2025_Yan_Lu.xlsx"
issa_code <- read.xlsx(issa_path, sheet = 1)
issa_data <- read.xlsx(issa_path, sheet = 2)

# Extract the skin spectrum data
issa <- issa_data[10:nrow(issa_data), ] # 360 nm: 13rd column, 780 nm: 55th column
colnames(issa) <- issa_data[9, ]

# Define body site codes and names
body_codes = as.character(1:12)
body_names = c("Back of Hand", "Cheek", "Cheek bone", "Chin", "Ear Lobe", "Forehead", "Inner arm", "Neck", "Nose tip", "Outer arm", "Palm", "Ring finger")
issa$G = body_names[as.numeric(issa$G)]
```

```{r compute}
# compute melanin index and erythema index
reflectance_to_absorbance <- function(reflectance) {
  -log10(reflectance / 100)
}

wavelengths = seq(400, 700, by=10)
reflectance = issa %>% dplyr::select(`400`:`700`)
colnames(reflectance) = paste0("R", wavelengths)
# calculate absorbance
absorbance = as.data.frame(lapply(reflectance, reflectance_to_absorbance))
colnames(absorbance) = paste0("A", wavelengths)
spectrum = cbind(issa %>% dplyr::select(A, C, G), reflectance, absorbance)
# calculate melanin index and erythema index
spectrum = spectrum %>% mutate(mi = 100 * `A680`,
                               ei = 100 * log10(`R680` / ((`R550` + `R560`)/2)))
colnames(spectrum)[3] = "site" # rename G to site
# extract face and palm spectra
face_spectrum = spectrum %>% filter(site %in% c("Cheek", "Forehead"))
face_spectrum$site = "Forehead/Cheek"
palm_spectrum = spectrum %>% filter(site == "Palm")
```


```{r util_plot_functions}
# ==============================================================================
# PLOTTING FUNCTIONS
# ==============================================================================

#' Generate skin reflectance spectra plot
#' 
#' Creates a plot showing reflectance spectra colored by melanin index
#' 
#' @param data 
#' @return A ggplot object
PlotReflectance <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>% 
    # Convert to long format
    pivot_longer(cols = matches("^R[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "reflectance") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
  
  plot <- ggplot(data_long, aes(x = wavelength, y = reflectance, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#fbf7ec"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    labs(
      x = "Wavelength (nm)",
      y = "Reflectance percentage of skin",
      color = "Melanin index"
    ) +
    guides(color = guide_colorbar(reverse = TRUE)) +
    # Highlight the region used for melanin index calculation
    geom_vline(xintercept = 680, color = "#ff0000")
  
  return(plot)
}

#' Generate skin absorbance spectra plot
#' 
#' Creates a plot showing absorbance spectra colored by melanin index
#' 
#' @param data 
#' @return A ggplot object
PlotAbsorbance <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>% 
    # Convert to long format
    pivot_longer(cols = matches("^A[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "absorbance") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
  
  plot <- ggplot(data_long, aes(x = wavelength, y = absorbance, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#fbf7ec"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    labs(
      x = "Wavelength (nm)",
      y = "Absorbance of skin",
      color = "Melanin index"
    ) +
    guides(color = guide_colorbar(reverse = TRUE)) +
    # Highlight the region used for melanin index calculation
    geom_vline(xintercept = 680, color = "#ff0000")
  
  return(plot)
}
```

```{r plot-derivatives}
# plot the first derivatives
PlotDerivative <- function(data, sample_size = NULL) {
  sample_size <- ifelse(is.null(sample_size), nrow(data), sample_size)
  # Prepare data for plotting
  data_long <- data %>%
    # Sample to prevent plot overload
    slice_sample(n = sample_size) %>%
    # Convert to long format
    pivot_longer(cols = matches("^[0-9]+$"), 
                 names_to = "wavelength", 
                 values_to = "delta") %>% 
    # Extract numeric wavelength values
    mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+"))) %>% 
    # Focus on visible spectrum
    filter(wavelength >= 400 & wavelength <= 700) # %>%
    
  plot <- ggplot(data_long, aes(x = wavelength, y = delta, group = A,
                          color = mi)) +
    geom_line(alpha = 0.6) +  # Add transparency to handle overlapping lines
    geom_hline(yintercept = 0, color = "black") +
    # Color gradient from dark to light skin
    scale_color_gradientn(
      colours = c("#42230c", "#a15c33", "#fbf7ec"),
      values = rescale(x = c(50, 40, 20)),
      oob = squish,
      limits = c(20, 130)
    ) +
    expand_limits(y = 0) +
    theme_classic() +
    guides(color = guide_colorbar(reverse = TRUE))
  
  return(plot)
}
```

```{r derivatives-face}

face_reflectance = as.matrix(face_spectrum %>% dplyr::select(`R400`:`R700`))
face_absorbance = as.matrix(face_spectrum %>% dplyr::select(`A400`:`A700`))

drv_facer = t(apply(face_reflectance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_facer) = wavelengths
drv_facer_df = as.data.frame(drv_facer) %>% mutate(A = face_spectrum$A, mi = face_spectrum$mi)

plot_drv_facer = PlotDerivative(drv_facer_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin reflectance",
      title = "First derivatives of skin reflectance",
      color = "Melanin index"
    )

drv_facea = t(apply(face_absorbance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_facea) = wavelengths
drv_facea_df = as.data.frame(drv_facea) %>% mutate(A = face_spectrum$A, mi = face_spectrum$mi)

plot_drv_facea = PlotDerivative(drv_facea_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin absorbance",
      title = "First derivatives of skin absorbance",
      color = "Melanin index"
    )
```

```{r outliers}
# remove outliers
outlier_index = which(drv_facer_df$`700`>1)
face_spectrum = face_spectrum[-outlier_index, ]
drv_facer = drv_facer[-outlier_index, ]
drv_facea = drv_facea[-outlier_index, ]
drv_facer_df = drv_facer_df[-outlier_index, ]
drv_facea_df = drv_facea_df[-outlier_index, ]


plot_drv_facer = PlotDerivative(drv_facer_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin reflectance",
      title = "First derivatives of skin reflectance",
      color = "Melanin index"
    )

plot_drv_facea = PlotDerivative(drv_facea_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin absorbance",
      title = "First derivatives of skin absorbance",
      color = "Melanin index"
    )
```

```{r derivatives-palm, fig.height=5}
palm_reflectance = as.matrix(palm_spectrum %>% dplyr::select(`R400`:`R700`))
palm_absorbance = as.matrix(palm_spectrum %>% dplyr::select(`A400`:`A700`))

drv_palmr = t(apply(palm_reflectance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials

colnames(drv_palmr) = wavelengths
drv_palmr_df = as.data.frame(drv_palmr) %>% mutate(A = palm_spectrum$A, mi = palm_spectrum$mi)
plot_drv_palmr = PlotDerivative(drv_palmr_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin reflectance",
      title = "First derivatives of skin reflectance",
      color = "Melanin index"
    )

drv_palma = t(apply(palm_absorbance, 1, function(spec) {
  drv_est = locpoly(x=wavelengths, y=spec, drv=1, degree=2, bandwidth=dpill(wavelengths, spec) * 0.7, gridsize=length(wavelengths))
  drv_est$y
})) # estimate the first derivatives using local polynomials
colnames(drv_palma) = wavelengths
drv_palma_df = as.data.frame(drv_palma) %>% mutate(A = palm_spectrum$A, mi = palm_spectrum$mi)
plot_drv_palma = PlotDerivative(drv_palma_df) + labs(
      x = "Wavelength (nm)",
      y = "Derivatives of skin absorbance",
      title = "First derivatives of skin absorbance",
      color = "Melanin index"
    )
```

```{r face mi}
# calculate representative face melanin index for each subject
face_ids = unique(issa$C[issa$G %in% c("Forehead", "Cheek")])
spectrum_filtered = spectrum %>% filter(C %in% face_ids)
spectrum_filtered$face_mi = NaN
for (id in face_ids) {
  spectrum_id = spectrum_filtered %>% filter(C == id)
  if (any(spectrum_id$site == "Forehead")) {
    face_mi = mean(spectrum_id$mi[spectrum_id$site == "Forehead"], na.rm = TRUE)
  } else {
    face_mi = mean(spectrum_id$mi[spectrum_id$site == "Cheek"], na.rm = TRUE)
  }
  spectrum_filtered$face_mi[spectrum_filtered$C == id] = face_mi
}

# define eumelanin classes based on representative face melanin index
eumelanin_classes_person = cut(spectrum_filtered$face_mi, breaks=c(0, 25, 50, 75, 100, 200))
eumelanin_classes_person = factor(eumelanin_classes_person, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high", "High"))

site_info = data.frame(subject = spectrum_filtered$C,
                       site = spectrum_filtered$site,
                       eumelanin_class = eumelanin_classes_person,
                       face_mi = spectrum_filtered$face_mi)
```

## Distribution of melanin index by site


```{r sample distribution, fig.width=10, fig.height=5}
# distribution of melanin index for Forehead, Cheek, and Palm
facepalm_spectrum = rbind(face_spectrum, palm_spectrum)

plot_face_mi = ggplot(face_spectrum, aes(x = mi, fill = site)) +
  geom_histogram(alpha = 0.5, position = "identity", binwidth = 5) +
  labs(x = "Melanin index", y = "Count", fill = "Site", title = "Forehead/Cheek") +
  xlim(0, 120) +
  scale_fill_brewer(palette = "Set2") +
  theme_classic()

plot_facepalm_mi = ggplot(facepalm_spectrum, aes(x = mi, fill = site)) +
  geom_histogram(alpha = 0.5, position = "identity", binwidth = 5) +
  labs(x = "Melanin index", y = "Count", fill = "Site", title = "Forehead/Cheek, and Palm") +
  xlim(0, 120) +
  scale_fill_brewer(palette = "Set2") +
  theme_classic()

wrap_plots(plot_face_mi, plot_facepalm_mi, ncol = 2) +
  plot_annotation(title = "Distribution of Melanin Index by Site")
pdf("output/mi_distribution.pdf", width = 10, height = 5)
wrap_plots(plot_face_mi, plot_facepalm_mi, ncol = 2)
dev.off()
```

## Unique subjects per site across representative face melanin index bins (Heatmap)


```{r heatmap, fig.width=10, fig.height=6}
# 1) Cut mi into 10 equal-width bins (adjust breaks as needed)
df_bins <- site_info %>%
  mutate(mi_bin = cut(face_mi, breaks = seq(0, 130, by = 10))) %>%   # or cut(mi, seq(min(mi), max(mi), by = 10))
  count(site, mi_bin, name = "n")

df_bins <- df_bins %>%
  tidyr::complete(site, mi_bin, fill = list(n = 0))


# 2) Heatmap
ggplot(df_bins, aes(x = mi_bin, y = site, fill = n)) +
  geom_tile(color = "white") +
  geom_text(aes(label = n), color = "white", size = 3) +
  scale_fill_viridis_c(option = "viridis") +
  labs(x = "Face MI, binned in 10-unit increments", y = "Site", fill = "Subject",
       title = "Unique subjects per site across 10-unit Face MI bins") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

pdf("output/heatmap.pdf", width = 10, height = 6)
ggplot(df_bins, aes(x = mi_bin, y = site, fill = n)) +
geom_tile(color = "white") +
geom_text(aes(label = n), color = "white", size = 3) +
scale_fill_viridis_c(option = "viridis") +
labs(x = "Face MI, binned in 10-unit increments", y = "Site", fill = "Subject",
      title = "Unique subjects per site across 10-unit Face MI bins") +
theme_minimal() +
theme(
  axis.text.x = element_text(angle = 45, hjust = 1),
  panel.grid = element_blank()
)
dev.off()
```


## First derivatives of reflectance by eumelanin classes

```{r eumelanin-class}
eumelanin_classes_face = cut(face_spectrum$mi, breaks=c(0, 25, 50, 75, 100, 150))
eumelanin_classes_face = factor(eumelanin_classes_face, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high", "High"))
face_spectrum$class = eumelanin_classes_face
drv_facer_df$class = eumelanin_classes_face
drv_facea_df$class = eumelanin_classes_face

eumelanin_classes_palm = cut(palm_spectrum$mi, breaks=c(0, 25, 50, 75, 100)) # no "High" class for palm
eumelanin_classes_palm = factor(eumelanin_classes_palm, labels = c("Low", "Intermediate low", "Intermediate", "Intermediate high"))
palm_spectrum$class = eumelanin_classes_palm
drv_palmr_df$class = eumelanin_classes_palm
drv_palma_df$class = eumelanin_classes_palm

# report the table of the number of subjects in each class
kable(table(eumelanin_classes_face), col.names = c("Eumelanin class", "Number of subjects"), caption = "Number of subjects in each eumelanin class (Forehead/Cheek)")
kable(table(eumelanin_classes_palm), col.names = c("Eumelanin class", "Number of subjects"), caption = "Number of subjects in each eumelanin class (Palm)")
```

```{r plot-reflectance-by-class-face, fig.width=10, fig.height=3.5}
plots_facer = list()
for (cls in levels(eumelanin_classes_face)) {
  cls_data = drv_facer_df %>% filter(class == cls)
  p = PlotDerivative(cls_data) + labs(
        x = "Wavelength (nm)",
        y = "Derivative",
        title = cls,
        color = "Melanin index"
      ) + ylim(-0.6, 0.8)
  plots_facer[[cls]] = p
}

wrap_plots(plots_facer, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin reflectance by eumelanin classes (Forehead/Cheek)") & theme(legend.position = "bottom")

pdf("output/reflectance_derivative_face.pdf", width = 10, height = 3.5)
wrap_plots(plots_facer, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin reflectance by eumelanin classes (Forehead/Cheek)") & theme(legend.position = "bottom")
dev.off()
```

```{r plot-reflectance-by-class-palm, fig.width=10, fig.height=4}
plots_palmr = list()
for (cls in levels(eumelanin_classes_palm)) {
  cls_data = drv_palmr_df %>% filter(class == cls)
  p = PlotDerivative(cls_data) + labs(
        x = "Wavelength (nm)",
        y = "Derivative",
        title = cls,
        color = "Melanin index"
      ) + ylim(-0.6, 0.8)
  plots_palmr[[cls]] = p
}

wrap_plots(plots_palmr, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin reflectance by eumelanin classes (PALM)") & theme(legend.position = "bottom")

pdf("output/reflectance_derivative_palm.pdf", width = 10, height = 4)
wrap_plots(plots_palmr, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin reflectance by eumelanin classes (PALM)") & theme(legend.position = "bottom")
dev.off()
```

## First derivatives of absorbance by eumelanin classes

```{r plot-absorbance-by-class-face, fig.width=10, fig.height=3.5}
plots_facea = list()
for (cls in levels(eumelanin_classes_face)) {
  cls_data = drv_facea_df %>% filter(class == cls)
  p = PlotDerivative(cls_data) + labs(
        x = "Wavelength (nm)",
        y = "Derivative",
        title = cls,
        color = "Melanin index"
      ) + ylim(-0.02, 0.02)
  plots_facea[[cls]] = p
}
wrap_plots(plots_facea, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin absorbance by eumelanin classes (Forehead/Cheek)") & theme(legend.position = "bottom")

pdf("output/absorbance_derivative_face.pdf", width = 10, height = 3.5)
wrap_plots(plots_facea, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin absorbance by eumelanin classes (Forehead/Cheek)") & theme(legend.position = "bottom")
dev.off()
```

```{r plot-absorbance-by-class-palm, fig.width=10, fig.height=4}
plots_palma = list()
for (cls in levels(eumelanin_classes_palm)) {
  cls_data = drv_palma_df %>% filter(class == cls)
  p = PlotDerivative(cls_data) + labs(
        x = "Wavelength (nm)",
        y = "Derivative",
        title = cls,
        color = "Melanin index"
      ) + ylim(-0.02, 0.02)
  plots_palma[[cls]] = p
}
wrap_plots(plots_palma, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin absorbance by eumelanin classes (PALM)") & theme(legend.position = "bottom")

pdf("output/absorbance_derivative_palm.pdf", width = 10, height = 4)
wrap_plots(plots_palma, nrow = 1, guides = "collect") + plot_annotation(title = "First derivatives of skin absorbance by eumelanin classes (PALM)") & theme(legend.position = "bottom")
dev.off()
```

```{r derivative-sd-mi}
# calculate the standard deviations in derivatives for a spectra curve
# face
sd_ref_face = apply(drv_facer, MARGIN = 1, sd)
sd_abs_face = apply(drv_facea, MARGIN = 1, sd)
sd_face = data.frame(site = "Forehead/Cheek", sd_ref = sd_ref_face, sd_abs = sd_abs_face, mi = face_spectrum$mi) %>% mutate(log_mi = log(mi))
# palm
sd_ref_palm = apply(drv_palmr, MARGIN = 1, sd)
sd_abs_palm = apply(drv_palma, MARGIN = 1, sd)
sd_palm = data.frame(site = "Palm", sd_ref = sd_ref_palm, sd_abs = sd_abs_palm, mi = palm_spectrum$mi) %>% mutate(log_mi = log(mi))
```

## Correlation between derivative sd and melanin index of reflectance

### Reflectance

```{r plot-derivative-sd-mi-ref, fig.width=10, fig.height=6}
# reflectance
plot_face_ref = ggplot(data = sd_face) + geom_point(aes(log_mi, sd_ref), color = "pink", size = 0.8) + theme_classic() +
  labs(title = "Forehead/Cheek Reflectance",
       x = "log(Melanin index)",
       y = "standard deviation of derivatives") + ylim(0, 0.25) + xlim(2.75, 4.75)
plot_palm_ref = ggplot(data = sd_palm) + geom_point(aes(log_mi, sd_ref), color = "steelblue", size = 0.8) + theme_classic() +
  labs(title = "Palm Reflectance",
       x = "log(Melanin index)",
       y = "standard deviation of derivatives") + ylim(0, 0.25) + xlim(2.75, 4.75)
wrap_plots(plot_face_ref, plot_palm_ref, nrow = 1, guides = "collect") + plot_annotation(title = "Correlation between reflectance derivative sd and melanin index") & theme(legend.position = "bottom")

pdf("output/reflectance_mi_sd.pdf", width = 10, height = 6)
wrap_plots(plot_face_ref, plot_palm_ref, nrow = 1, guides = "collect") + plot_annotation(title = "Correlation between reflectance derivative sd and melanin index") & theme(legend.position = "bottom")
dev.off()
```

- Regression analysis

```{r regression-drv-mi, fig.width=10, fig.height=6}
# polinomial regression for reflectance sd vs log(mi)
# face
reg_face_model = lm(sd_ref ~ log_mi + I(log_mi^2), data = sd_face)
summary(reg_face_model)
# plot with polinomial regression line
plot_face_reg = plot_face_ref + geom_smooth(aes(log_mi, sd_ref), method = "lm", formula = y ~ poly(x, 2), color = "black", se = FALSE)

# palm
reg_palm_model = lm(sd_ref ~ log_mi, data = sd_palm)
summary(reg_palm_model)
# plot with polinomial regression line
plot_palm_reg = plot_palm_ref + geom_smooth(aes(log_mi, sd_ref), method = "lm", formula = y ~ poly(x, 1), color = "black", se = FALSE)

wrap_plots(plot_face_reg, plot_palm_reg, nrow = 1, guides = "collect") + plot_annotation(title = "Regression of reflectance derivative sd on log(melanin index)") & theme(legend.position = "bottom")

pdf("output/reflectance_mi_sd_regression.pdf", width = 10, height = 6)
wrap_plots(plot_face_reg, plot_palm_reg, nrow = 1, guides = "collect") + plot_annotation(title = "Regression of reflectance derivative sd on log(melanin index)") & theme(legend.position = "bottom")
dev.off()
```

### Absorbance

```{r plot-derivative-sd-mi-abs, fig.width=10, fig.height=6}
# absorbance
plot_face_abs = ggplot(data = sd_face) + geom_point(aes(log_mi, sd_abs), color = "pink", size = 0.8) + theme_classic() +
  labs(title = "Forehead/Cheek Absorbance",
       x = "log(Melanin index)",
       y = "standard deviation of derivatives") + ylim(0, 0.0055) + xlim(2.75, 4.75)
plot_palm_abs = ggplot(data = sd_palm) + geom_point(aes(log_mi, sd_abs), color = "steelblue", size = 0.8) + theme_classic() +
  labs(title = "Palm Absorbance",
       x = "log(Melanin index)",
       y = "standard deviation of derivatives") + ylim(0, 0.0055) + xlim(2.75, 4.75)

wrap_plots(plot_face_abs, plot_palm_abs, nrow = 1, guides = "collect") + plot_annotation(title = "Correlation between absorbance derivative sd and melanin index") & theme(legend.position = "bottom")

pdf("output/absorbance_mi_sd.pdf", width = 10, height = 6)
wrap_plots(plot_face_abs, plot_palm_abs, nrow = 1, guides = "collect") + plot_annotation(title = "Correlation between absorbance derivative sd and melanin index") & theme(legend.position = "bottom")
dev.off()
```

## Correlation between erythema index and melanin index

```{r ei-mi-correlation, fig.width=10, fig.height=6}
# face
plot_face_ei = ggplot(data = face_spectrum) + geom_point(aes(mi, ei), color = "pink", size = 0.8) + theme_classic() +
  labs(title = "Forehead/Cheek",
       x = "Melanin index",
       y = "Erythema index") + xlim(0, 120) + ylim(10, 55)
# palm
plot_palm_ei = ggplot(data = palm_spectrum) + geom_point(aes(mi, ei), color = "steelblue", size = 0.8) + theme_classic() +
  labs(title = "Palm",
       x = "Melanin index",
       y = "Erythema index") + xlim(0, 120) + ylim(10, 55)
wrap_plots(plot_face_ei, plot_palm_ei, nrow = 1, guides = "collect") + plot_annotation(title = "Correlation between erythema index and melanin index") & theme(legend.position = "bottom")

pdf("output/ei_mi_correlation.pdf", width = 10, height = 6)
wrap_plots(plot_face_ei, plot_palm_ei, nrow = 1, guides = "collect") + plot_annotation(title = "Correlation between erythema index and melanin index") & theme(legend.position = "bottom")
dev.off()
```